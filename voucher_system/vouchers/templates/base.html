{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voucher Approval System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11/font/bootstrap-icons.css">
    <style>
        .btn-warning { min-width: 180px; }
        .btn-lg { min-height: 50px; }
        .file-name { font-size: 0.9em; color: #555; }
        /* WIDER CREATE VOUCHER MODAL */
        #createVoucherModal .modal-dialog {
            max-width: 90vw !important;
            width: 1400px;
            margin: 1.75rem auto;
        }
        @media (max-width: 1500px) {
            #createVoucherModal .modal-dialog { width: 95vw; }
        }
        #createVoucherModal .modal-body { max-height: 75vh; overflow-y: auto; }
        #particularsTable th, #particularsTable td { vertical-align: middle; }
        .navbar .dropdown-toggle::after { display: none; }
        .grip-handle { cursor: move; color: #6c757d; }
        .list-group-item:hover .grip-handle { color: #495057; }
    </style>
    <script>window.csrfToken = "{{ csrf_token }}";</script>
</head>
<body>
    {% now "Y-m-d" as today %}
    <script>window.today = "{{ today }}";</script>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand p-0" href="{% url 'home' %}">
    {% if company_logo_url %}
        <img src="{{ company_logo_url }}" 
             alt="Company Logo" 
             class="img-fluid" 
             style="height: 45px; width: auto; max-width: 200px; object-fit: contain;">
    {% endif %}
</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="{% url 'voucher_list' %}">Vouchers</a></li>
                </ul>
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary fw-bold d-flex align-items-center gap-2"
                               href="#" role="button" data-bs-toggle="dropdown">
                                {{ user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow">
    {% if user.is_superuser %}
    <li><a class="dropdown-item" href="{% url 'admin:index' %}">Admin Panel</a></li>
    <li><hr class="dropdown-divider"></li>
    {% endif %}

    <!-- CHANGE PASSWORD -->
    <li>
        <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
    <i class="bi bi-key me-2"></i>Change Password
</a>
    </li>
<li>
    <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#updateSignatureModal">
        <i class="bi bi-pen me-2"></i>Update Signature
    </a>
</li>
    <!-- LOGOUT -->
    <li>
        <a class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#logoutModal">
            <i class="bi bi-box-arrow-right me-2"></i>Logout
        </a>
    </li>
</ul>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <!-- FLASH MESSAGES -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
   
    <!-- (Buttons removed as requested) -->
    <div class="container mt-4">{% block content %}{% endblock %}</div>
    <!-- LOGOUT MODAL -->
    {% if user.is_authenticated %}
    <div class="modal fade" id="logoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><p>Are you sure you to log out?</p></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'logout' %}" class="d-inline">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <button type="submit" class="btn btn-danger">Yes, Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- SUCCESS MODAL -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title d-flex align-items-center gap-2">Success</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="mb-0 fs-5" id="successMessage">Voucher created successfully!</p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-success px-5" data-bs-dismiss="modal" id="successOkBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CHANGE PASSWORD MODAL -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock me-2"></i>Change Password
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="old_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="new_password1" required minlength="8">
                        <small class="text-muted">Minimum 8 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="new_password2" required>
                    </div>
                    <div id="passwordError" class="alert alert-danger d-none"></div>
                    <div id="passwordSuccess" class="alert alert-success d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- UPDATE SIGNATURE MODAL -->
<div class="modal fade" id="updateSignatureModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pen me-2"></i>Update Signature
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateSignatureForm" enctype="multipart/form-data">
                <div class="modal-body text-center">
                    {% if user.userprofile.signature %}
                        <div class="mb-4">
                            <p class="text-muted small mb-2">Current Signature:</p>
                            <img src="{{ user.userprofile.signature.url }}?t={{ user.userprofile.signature.url|cut:'.'|length }}" 
                                 alt="Current Signature" 
                                 class="border rounded p-2 bg-white" 
                                 style="max-height: 100px;">
                        </div>
                    {% else %}
                        <p class="text-muted mb-4">No signature uploaded yet.</p>
                    {% endif %}

                    <div class="mb-3">
                        <label class="form-label">Upload New Signature <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" name="signature" accept="image/png,image/jpeg" required>
                        <small class="text-muted d-block mt-2">
                            PNG or JPG • Transparent background recommended • Max 2MB
                        </small>
                    </div>

                    <div id="signatureError" class="alert alert-danger d-none mt-3"></div>
                    <div id="signatureSuccess" class="alert alert-success d-none mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> Update Signature
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    <!-- CREATE DESIGNATION MODAL -->
    <div class="modal fade" id="createDesignationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="createDesignationForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Designation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="designation_name" class="form-label">Designation Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="designation_name" name="name" required maxlength="100">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- CREATE USER MODAL (SUPERUSER ONLY) -->
    {% if user.is_superuser %}
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="createUserForm" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="user_username" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="user_username" name="username" required maxlength="150">
                        </div>
                        <div class="mb-3">
                            <label for="user_password" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="user_password" name="password" required minlength="8">
                        </div>
                        <div class="mb-3">
                            <label for="user_group" class="form-label">User Group <span class="text-danger">*</span></label>
                            <select name="user_group" id="user_group" class="form-select" required>
                                <option value="">-- Select Group --</option>
                                <option value="Accountants">Accountants</option>
                                <option value="Admin Staff">Admin Staff</option>
                            </select>
                        </div>
                        <div class="mb-3" id="designation_field_user" style="display:none;">
                            <label for="user_designation" class="form-label">Designation <span class="text-danger">*</span></label>
                            <select name="designation" id="user_designation" class="form-select">
                                <option value="">-- Select Designation --</option>
                                {% for des in designations %}
                                    <option value="{{ des.id }}">{{ des.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- NEW: SIGNATURE UPLOAD -->
                        <div class="mb-3">
                            <label for="user_signature" class="form-label">Signature (Optional)</label>
                            <input type="file" class="form-control form-control-sm" id="user_signature" name="signature" accept="image/png,image/jpeg">
                            <div class="form-text">Upload a clear PNG/JPG of your signature (transparent background preferred).</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- CONTROL APPROVAL MODAL -->
    {% if user.is_superuser %}
    <div class="modal fade" id="approvalControlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Control Approval Workflow</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Drag to reorder. All designations are active by default.</p>
                    <div id="approvalLevelsList" class="list-group"></div>
                    <div class="mt-3">
                        <select id="addDesignationSelect" class="form-select">
                            <option value="">-- Add Designation --</option>
                        </select>
                        <button id="addDesignationBtn" class="btn btn-sm btn-outline-primary mt-2">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveApprovalControl">Save Order</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- USER CONTROL MODAL (SUPERUSER ONLY) -->
    {% if user.is_superuser %}
    <div class="modal fade" id="userControlModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Control Panel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle" id="userControlTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Username</th>
                                    <th>Group</th>
                                    <th>Designation</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in all_users %}
                                <tr data-user-id="{{ u.id }}">
                                    <td>{{ u.username }}</td>
                                    <td>{{ u.groups.all.0.name|default:"—" }}</td>
                                    <td>{{ u.userprofile.designation.name|default:"—" }}</td>
                                    <td>
                                        <span class="badge bg-{{ u.is_active|yesno:'success,danger' }}">
                                            {{ u.is_active|yesno:'Active,Disabled' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-user-btn"
                                                data-id="{{ u.id }}"
                                                data-username="{{ u.username }}"
                                                data-group="{{ u.groups.all.0.name|default:'' }}"
                                                data-designation="{{ u.userprofile.designation.id|default:'' }}"
                                                data-active="{{ u.is_active|yesno:'true,false' }}"
                                                data-signature="{% if u.userprofile.signature %}{{ u.userprofile.signature.url }}{% endif %}">
                                            Edit
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center text-muted">No users found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- EDIT USER MODAL (inside User Control) -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editUserForm" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit_user_id">
                        <div class="mb-3">
                            <label class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_username" required maxlength="150">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Group <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit_user_group" required>
                                <option value="Accountants">Accountants</option>
                                <option value="Admin Staff">Admin Staff</option>
                            </select>
                        </div>
                        <div class="mb-3" id="edit_designation_field" style="display:none;">
                            <label class="form-label">Designation <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit_user_designation">
                                <option value="">-- Select Designation --</option>
                                {% for des in designations %}
                                <option value="{{ des.id }}">{{ des.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="edit_user_active">
                                <label class="form-check-label" for="edit_user_active">Active</label>
                            </div>
                        </div>
                        <!-- NEW: SIGNATURE UPLOAD + PREVIEW -->
                        <div class="mb-3">
                            <label class="form-label">Signature</label>
                            <input type="file" class="form-control form-control-sm" id="edit_user_signature" name="signature" accept="image/png,image/jpeg">
                            <div class="form-text">Leave blank to keep current signature.</div>
                            <div id="currentSignaturePreview" class="mt-2 text-center" style="display:none;">
                                <p class="small text-muted mb-1">Current Signature:</p>
                                <img id="currentSignatureImg" src="" alt="Current Signature" style="max-height: 60px; border: 1px dashed #ccc; padding: 5px;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
   
    <!-- NEW: ACCOUNT CONTROL MODAL (SUPERUSER ONLY) -->
    {% if user.is_superuser %}
    <div class="modal fade" id="accountControlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Bank Accounts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAccountForm" class="row g-3 mb-4">
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" placeholder="Bank Name" id="bank_name" required>
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" placeholder="Account Number" id="account_number" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-success btn-sm w-100">Add</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="accountTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Bank Name</th>
                                    <th>Account Number</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- UPDATED: COMPANY DETAILS MODAL (SUPERUSER ONLY) -->
    {% if user.is_superuser %}
    <div class="modal fade" id="companyDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="companyDetailsForm" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">View / Edit Company Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- No data message -->
                        <div id="noCompanyMessage" class="alert alert-info text-center mb-3" style="display: none;">
                            No company details have been added yet. Fill the form below to add.
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Company Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="company_name" name="name" required maxlength="200">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">GST No</label>
                                <input type="text" class="form-control" id="company_gst" name="gst_no" maxlength="15" placeholder="e.g. 22AAAAA0000A1Z5">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">PAN No</label>
                                <input type="text" class="form-control" id="company_pan" name="pan_no" maxlength="10" placeholder="e.g. ABCDE1234F">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" id="company_address" name="address" rows="2"></textarea>
                            </div>
                            <!-- ADDED: EMAIL & PHONE -->
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="company_email" name="email" placeholder="company@example.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" id="company_phone" name="phone" placeholder="+91 9876543210">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Logo (PNG/JPG, max 2MB)</label>
                                <input type="file" class="form-control form-control-sm" id="company_logo" name="logo" accept="image/png,image/jpeg">
                                <div class="mt-2 text-center" id="currentLogoPreview" style="display:none;">
                                    <p class="small text-muted mb-1">Current Logo:</p>
                                    <img id="currentLogoImg" src="" alt="Current Logo" style="max-height: 80px; border: 1px dashed #ccc; padding: 5px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Details</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- CREATE VOUCHER MODAL - WORKS FOR ACCOUNTANTS, ADMIN STAFF & SUPERUSER -->
    {% if user.is_authenticated %}
        {% with user_group=user.groups.all.0.name %}
            {% if user_group == 'Accountants' or user_group == 'Admin Staff' or user.is_superuser %}
                <div class="modal fade" id="createVoucherModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Voucher</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createVoucherForm" enctype="multipart/form-data">
                                    <!-- 1. Voucher Date - Top Right -->
                                    <div class="text-end mb-4">
                                        <div class="d-inline-block" style="width: 180px;">
                                            <label for="voucher_date" class="form-label fw-bold text-primary">
                                                Voucher Date <span class="text-danger">*</span>
                                            </label>
                                            <input type="date" class="form-control form-control-sm" id="voucher_date" name="voucher_date" max="{{ today }}" required>
                                        </div>
                                    </div>
                                    <!-- 2. Title (SUPER SMALL) + Pay To (Full) -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-2">
                                            <label for="name_title" class="form-label">Title <span class="text-danger">*</span></label>
                                            <select class="form-select form-select-sm" id="name_title" name="name_title" required>
                                                <option value="MR">Mr.</option>
                                                <option value="MRS">Mrs.</option>
                                                <option value="MS">Ms.</option>
                                            </select>
                                        </div>
                                        <div class="col-md-10">
                                            <label for="pay_to" class="form-label">Pay To <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="pay_to" name="pay_to" required placeholder="Enter full name"  oninput="this.value = this.value.toUpperCase();">
                                        </div>
                                    </div>
                                    <!-- 3. Payment Type + CHEQUE FIELDS IN ONE ROW -->
                                    <div class="mb-3">
                                        <div class="row g-3 align-items-end">
                                            <!-- Payment Type -->
                                            <div class="col-md-3">
                                                <label for="payment_type" class="form-label">Payment Type <span class="text-danger">*</span></label>
                                                <select class="form-select form-select-sm" id="payment_type" name="payment_type" required>
                                                    <option value="CASH">Cash</option>
                                                    <option value="CHEQUE">Cheque</option>
                                                    <option value="PETTY_CASH">Petty Cash</option>
                                                </select>
                                            </div>
                                            <!-- Cheque Number -->
                                            <div class="col-md-2" id="chequeNumberField" style="display:none;">
                                                <label for="cheque_number" class="form-label">Cheque Number <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" id="cheque_number" name="cheque_number" placeholder="e.g. 123456" maxlength="20">
                                            </div>
                                            <!-- Cheque Date -->
                                            <div class="col-md-2" id="chequeDateField" style="display:none;">
                                                <label for="cheque_date" class="form-label">Cheque Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control form-control-sm" id="cheque_date" name="cheque_date" max="{{ today }}">
                                            </div>
                                            <!-- Account Details - REQUIRED, NO NULL -->
                                            <div class="col-md-3" id="accountDetailsField" style="display:none;">
                                                <label for="account_details" class="form-label">Account Details <span class="text-danger">*</span></label>
                                                <select class="form-select form-select-sm" id="account_details" name="account_details" required>
                                                    <!-- Options filled by loadAccounts() -->
                                                </select>
                                            </div>
                                            <!-- Cheque Attachment (NOW MULTIPLE) -->
                                            <!-- CHEQUE ATTACHMENTS - CORRECT -->
<div class="col-md-2" id="chequeAttachmentField" style="display:none;">
    <label class="form-label">Cheque Attachments <span class="text-danger">*</span></label>
    <input type="file"
           class="form-control form-control-sm"
           name="cheque_attachments"
           id="cheque_attachments"
           multiple
           accept="image/*,application/pdf">
    
</div>
                                        </div>
                                    </div>
                                    <!-- 5. Main Attachment (NOW MULTIPLE & OPTIONAL) -->
                                    <!-- MAIN ATTACHMENTS - CORRECT -->
<div class="mb-4" style="max-width: 500px;">
    <label class="form-label">Main Attachments</label>
    <input type="file"
       id="main_attachments"
       name="main_attachments"
       class="form-control form-control-sm"
       multiple
       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
           <div id="fileName" class="text-muted small mt-1"></div>

</div>
                                    <!-- REMOVED: EMAIL & PHONE FROM VOUCHER FORM -->
                                    <hr class="my-4">
                                    <!-- PARTICULARS -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Particulars <span class="text-danger">*</span></label>
                                        <table class="table table-sm table-bordered" id="particularsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th width="40%">Description</th>
                                                    <th width="20%">Amount</th>
                                                    <th width="30%">Attachments </th>
                                                    <th width="10%"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="particularsBody">
                                                <tr>
                                                    <td><input type="text" class="form-control form-control-sm" name="particulars[0][description]" required  oninput="this.value = this.value.toUpperCase();"></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm" name="particulars[0][amount]" required></td>
                                                    <td>
                                                        <input type="file" class="form-control form-control-sm"
                                                            name="particular_attachment_0"
                                                            multiple
                                                            accept="image/*,application/pdf"
                                                            required>

                                                        <div class="mt-1 text-muted small particular-file-list"></div>
                                                    </td>
                                                    <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <button type="button" class="btn btn-sm btn-primary" id="addParticular">Add Row</button>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">Submit Voucher</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endwith %}
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
    document.addEventListener('DOMContentLoaded', function () {
        const getCsrfToken = () => window.csrfToken;
        // -------------------------------------------------
        // GLOBAL: Load bank accounts into the dropdown (NO NULL)
        // -------------------------------------------------
        function loadAccounts() {
            const select = document.getElementById('account_details');
            if (!select) return;
            select.innerHTML = ''; // Remove "Null" option
            fetch("{% url 'account_list' %}")
                .then(r => r.json())
                .then(accounts => {
                    if (accounts.length === 0) {
                        const opt = document.createElement('option');
                        opt.value = "";
                        opt.textContent = "-- No Accounts --";
                        opt.disabled = true;
                        select.appendChild(opt);
                    } else {
                        accounts.forEach(acc => {
                            const opt = document.createElement('option');
                            opt.value = acc.value;
                            opt.textContent = acc.label;
                            select.appendChild(opt);
                        });
                    }
                })
                .catch(() => {
                    const opt = document.createElement('option');
                    opt.value = "";
                    opt.textContent = "-- Load Failed --";
                    opt.disabled = true;
                    select.appendChild(opt);
                });
        }
        loadAccounts();
        // -------------------------------------------------
        // Auto-fill date
        // -------------------------------------------------
        const dateInput = document.getElementById('voucher_date');
        if (dateInput) {
            dateInput.value = window.today;
            dateInput.max = window.today;
        }
        // === CREATE DESIGNATION ===
        const createForm = document.getElementById('createDesignationForm');
        if (createForm) {
            createForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const name = this.querySelector('#designation_name').value.trim();
                if (!name) return alert('Name required');
                fetch("{% url 'designation_create_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.id) {
                        alert('Designation created!');
                        bootstrap.Modal.getInstance(document.getElementById('createDesignationModal')).hide();
                        location.reload();
                    } else alert('Error: ' + (d.error || 'Failed'));
                });
            });
        }
        // === CREATE USER ===
        const userForm = document.getElementById('createUserForm');
        if (userForm) {
            const groupSelect = document.getElementById('user_group');
            const designationField = document.getElementById('designation_field_user');
            const designationSelect = document.getElementById('user_designation');
            groupSelect.addEventListener('change', function() {
                if (this.value === 'Admin Staff') {
                    designationField.style.display = 'block';
                    designationSelect.setAttribute('required', 'required');
                } else {
                    designationField.style.display = 'none';
                    designationSelect.removeAttribute('required');
                    designationSelect.value = '';
                }
            });
            userForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData();
                formData.append('username', document.getElementById('user_username').value.trim());
                formData.append('password', document.getElementById('user_password').value);
                formData.append('user_group', document.getElementById('user_group').value);
                const designation = document.getElementById('user_designation').value;
                if (document.getElementById('user_group').value === 'Admin Staff') {
                    if (!designation) return alert('Designation required for Admin Staff');
                    formData.append('designation', designation);
                }
                const signature = document.getElementById('user_signature').files[0];
                if (signature) formData.append('signature', signature);
                fetch("{% url 'user_create_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken() },
                    body: formData
                })
                .then(r => r.json())
                .then(d => {
                    if (d.id) {
                        alert('User created!');
                        bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                        userForm.reset();
                        document.getElementById('designation_field_user').style.display = 'none';
                        location.reload();
                    } else alert('Error: ' + (d.error || 'Failed'));
                });
            });
        }
        // === APPROVAL CONTROL ===
        const controlModal = document.getElementById('approvalControlModal');
        if (controlModal) {
            const list = document.getElementById('approvalLevelsList');
            const select = document.getElementById('addDesignationSelect');
            const addBtn = document.getElementById('addDesignationBtn');
            const saveBtn = document.getElementById('saveApprovalControl');
            let allDesignations = [], currentLevels = [];
            function render() {
                list.innerHTML = '';
                currentLevels.forEach((lvl, idx) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.draggable = true;
                    item.dataset.id = lvl.id;
                    item.innerHTML = `
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-grip-vertical grip-handle"></i>
                            <strong>${idx + 1}.</strong>
                            <span>${lvl.name}</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger ms-2 remove-level">Remove</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
                const used = currentLevels.map(l => l.id);
                select.innerHTML = '<option value="">-- Add Designation --</option>';
                allDesignations.forEach(d => {
                    if (!used.includes(d.id)) {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.name;
                        select.appendChild(opt);
                    }
                });
            }
            fetch("{% url 'approval_control_api' %}").then(r => r.json()).then(data => {
                allDesignations = data.all_designations;
                currentLevels = data.levels.map(l => ({ id: l.id, name: l.name }));
                render();
            });
            let dragged;
            list.addEventListener('dragstart', e => { dragged = e.target.closest('.list-group-item'); });
            list.addEventListener('dragover', e => e.preventDefault());
            list.addEventListener('drop', e => {
                e.preventDefault();
                const after = [...list.querySelectorAll('.list-group-item')].reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset, element: child };
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
                if (after == null) list.appendChild(dragged);
                else list.insertBefore(dragged, after);
            });
            addBtn.onclick = () => {
                const id = parseInt(select.value);
                const name = select.selectedOptions[0].textContent;
                if (id) { currentLevels.push({ id, name }); render(); }
            };
            list.onclick = e => {
                const item = e.target.closest('.list-group-item');
                if (!item) return;
                if (e.target.classList.contains('remove-level')) {
                    currentLevels = currentLevels.filter(l => l.id != item.dataset.id);
                    render();
                }
            };
            saveBtn.onclick = () => {
                const levels = Array.from(list.children).map(el => ({
                    id: parseInt(el.dataset.id)
                }));
                fetch("{% url 'approval_control_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ levels })
                })
                .then(r => r.json())
                .then(d => {
                    alert(d.message || 'Saved!');
                    bootstrap.Modal.getInstance(controlModal).hide();
                    location.reload();
                });
            };
        }
        // === ACCOUNT CONTROL MODAL ===
        const accountModal = document.getElementById('accountControlModal');
        if (accountModal) {
            const tableBody = accountModal.querySelector('#accountTable tbody');
            const addForm = accountModal.querySelector('#addAccountForm');
            function loadAccounts() {
                fetch("{% url 'account_list' %}").then(r => r.json()).then(accounts => {
                    tableBody.innerHTML = '';
                    accounts.forEach(acc => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${acc.label.split(' / ')[0]}</td>
                            <td>${acc.label.split(' / ')[1]}</td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-account" data-id="${acc.value}">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                });
            }
            accountModal.addEventListener('show.bs.modal', loadAccounts);
            addForm.onsubmit = e => {
                e.preventDefault();
                const bank = document.getElementById('bank_name').value.trim();
                const acc = document.getElementById('account_number').value.trim();
                if (!bank || !acc) return;
                fetch("{% url 'account_create' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bank_name: bank, account_number: acc })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.id) {
                        addForm.reset();
                        loadAccounts();
                    } else alert('Error: ' + (d.error || 'Failed'));
                });
            };
            tableBody.onclick = e => {
                const btn = e.target.closest('.delete-account');
                if (!btn) return;
                if (!confirm('Delete this account?')) return;
                const id = btn.dataset.id;
                fetch(`/api/accounts/delete/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCsrfToken() }
                })
                .then(r => {
                    if (r.ok) {
                        loadAccounts();
                    } else {
                        alert('Failed to delete');
                    }
                })
                .catch(() => alert('Error deleting account'));
            };
        }
                // === EDIT USER (USER CONTROL PANEL) ===
        const editUserModalEl = document.getElementById('editUserModal');
        if (editUserModalEl) {
            const editModal = new bootstrap.Modal(editUserModalEl);
            const form = document.getElementById('editUserForm');
            const groupSelect = document.getElementById('edit_user_group');
            const designationField = document.getElementById('edit_designation_field');
            const designationSelect = document.getElementById('edit_user_designation');

            // When clicking any "Edit" button in User Control table
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const userId = this.dataset.id;
                    const username = this.dataset.username;
                    const group = this.dataset.group;
                    const designationId = this.dataset.designation || '';
                    const isActive = this.dataset.active === 'true';
                    const signatureUrl = this.dataset.signature || '';

                    // Fill the form
                    document.getElementById('edit_user_id').value = userId;
                    document.getElementById('edit_username').value = username;
                    document.getElementById('edit_user_group').value = group || 'Accountants';
                    document.getElementById('edit_user_active').checked = isActive;

                    // Show/hide designation
                    if (group === 'Admin Staff') {
                        designationField.style.display = 'block';
                        designationSelect.closest('.mb-3').querySelector('label').innerHTML = 'Designation <span class="text-danger">*</span>';
                    } else {
                        designationField.style.display = 'none';
                    }
                    designationSelect.value = designationId;

                    // Show current signature preview if exists
                    const preview = document.getElementById('currentSignaturePreview');
                    const img = document.getElementById('currentSignatureImg');
                    if (signatureUrl) {
                        preview.style.display = 'block';
                        img.src = signatureUrl + '?t=' + Date.now(); // cache bust
                    } else {
                        preview.style.display = 'none';
                    }

                    // Show modal
                    editModal.show();
                });
            });

            // Handle group change (show/hide designation)
            groupSelect.addEventListener('change', function () {
                if (this.value === 'Admin Staff') {
                    designationField.style.display = 'block';
                    designationSelect.setAttribute('required', 'required');
                } else {
                    designationField.style.display = 'none';
                    designationSelect.removeAttribute('required');
                    designationSelect.value = '';
                }
            });

            // Submit edit form
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData();
                formData.append('user_id', document.getElementById('edit_user_id').value);
                formData.append('username', document.getElementById('edit_username').value.trim());
                formData.append('user_group', groupSelect.value);
                formData.append('is_active', document.getElementById('edit_user_active').checked);

                if (groupSelect.value === 'Admin Staff') {
                    const des = designationSelect.value;
                    if (!des) return alert('Designation required for Admin Staff');
                    formData.append('designation', des);
                }

                const signatureFile = document.getElementById('edit_user_signature').files[0];
                if (signatureFile) formData.append('signature', signatureFile);

                fetch("{% url 'user_update_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken() },
                    body: formData
                })
                .then(r => r.json())
                .then(d => {
                    if (d.message) {
                        alert('User updated successfully!');
                        editModal.hide();
                        location.reload();
                    } else {
                        alert('Error: ' + (d.error || 'Update failed'));
                    }
                })
                .catch(() => alert('Network error'));
            });
        }
        // === CREATE VOUCHER ===
        const voucherModal = document.getElementById('createVoucherModal');
        if (voucherModal) {
            const form = document.getElementById('createVoucherForm');
            const tbody = document.getElementById('particularsBody');
            const addBtn = document.getElementById('addParticular');
            let index = 1;
            const paymentTypeSelect = document.getElementById('payment_type');
            const chequeField = document.getElementById('chequeNumberField');
            const chequeInput = document.getElementById('cheque_number');
            const chequeAttachmentField = document.getElementById('chequeAttachmentField');
            
            const chequeDateField = document.getElementById('chequeDateField');
            const chequeDateInput = document.getElementById('cheque_date');
            const accountDetailsField = document.getElementById('accountDetailsField');
            const accountDetailsSelect = document.getElementById('account_details');
            

            voucherModal.addEventListener('show.bs.modal', loadAccounts);
            // Show/Hide Cheque Fields
function toggleChequeFields() {
    if (!paymentTypeSelect) return;

    // get the actual <select id="account_details"> element (may be inside the modal form)
    const accountDetailsSelect = document.getElementById('account_details');

    if (paymentTypeSelect.value === "CHEQUE") {
        chequeField.style.display = "block";
        chequeDateField.style.display = "block";
        accountDetailsField.style.display = "block";
        chequeAttachmentField.style.display = "block";

        // Make account_details required only when cheque selected
        if (accountDetailsSelect) accountDetailsSelect.required = true;
    } else {
        chequeField.style.display = "none";
        chequeDateField.style.display = "none";
        accountDetailsField.style.display = "none";
        chequeAttachmentField.style.display = "none";

        // Remove required so browser won't block submit when hidden
        if (accountDetailsSelect) accountDetailsSelect.required = false;
    }
}


// When user changes payment type
paymentTypeSelect?.addEventListener("change", toggleChequeFields);

// When modal opens
voucherModal?.addEventListener("shown.bs.modal", toggleChequeFields);

// Initial load
const mainAttachmentInput = document.getElementById('main_attachments');
            const chequeAttachmentInput = document.getElementById('cheque_attachments');
toggleChequeFields();

            // File name display for main & cheque
            mainAttachmentInput?.addEventListener('change', e => {
                const files = Array.from(e.target.files);
                document.getElementById('fileName').innerHTML = files.length ? files.map(f => `Selected: ${f.name}`).join('<br>') : '';
            });
            chequeAttachmentInput?.addEventListener('change', e => {
                const files = Array.from(e.target.files);
                document.getElementById('chequeFileName').innerHTML = files.length ? files.map(f => `Selected: ${f.name}`).join('<br>') : '';
            })

            
            addBtn.onclick = () => {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" 
                   name="particulars[${index}][description]" required></td>

        <td><input type="number" step="0.01" class="form-control form-control-sm" 
                   name="particulars[${index}][amount]" required></td>

        <td>
            <input type="file"
                   class="form-control form-control-sm"
                   name="particular_attachment_${index}"
                   multiple
                   accept="image/*,application/pdf"
                   required>

            <div class="mt-1 text-muted small particular-file-list"></div>
        </td>

        <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
    `;
    tbody.appendChild(row);
    index++;
};


            tbody.onclick = e => {
                if (e.target.classList.contains('remove-row') && tbody.children.length > 1)
                    e.target.closest('tr').remove();
            };

            // File list for each particular row
            tbody.addEventListener('change', e => {
                if (e.target.name.startsWith("particular_attachment_")) {

                    const files = Array.from(e.target.files);
                    const div = e.target.closest('td').querySelector('.particular-file-list');
                    div.innerHTML = files.length ? `${files.length} file(s) selected` : '';
                }
            });

            form.onsubmit = e => {
                e.preventDefault();
                const formData = new FormData();
                const voucherDate = document.getElementById('voucher_date').value;
                const paymentType = document.getElementById('payment_type').value;
                const nameTitle = document.getElementById('name_title').value;
                const payTo = document.getElementById('pay_to').value.trim();

                if (!voucherDate || !paymentType || !nameTitle || !payTo)
                    return alert('Fill all required fields');

                formData.append('voucher_date', voucherDate);
                formData.append('payment_type', paymentType);
                formData.append('name_title', nameTitle);
                formData.append('pay_to', payTo);

                // Main attachments
                if (mainAttachmentInput?.files.length) {
                    Array.from(mainAttachmentInput.files).forEach(file => {
                        formData.append('main_attachments', file);
                    });
                }

                if (paymentType === 'CHEQUE') {
                    const cn = chequeInput.value.trim();
                    if (!cn) return alert('Cheque number required');
                    formData.append('cheque_number', cn);
                    const chequeFiles = chequeAttachmentInput?.files;
                    if (!chequeFiles || chequeFiles.length === 0) return alert('At least one cheque attachment required');
                    Array.from(chequeFiles).forEach(file => formData.append('cheque_attachments', file));
                    const chequeDate = chequeDateInput.value;
                    if (!chequeDate) return alert('Cheque date required');
                    formData.append('cheque_date', chequeDate);
                    const accVal = accountDetailsSelect.value;
                    if (!accVal) return alert('Account Details required for Cheque');
                    formData.append('account_details', accVal);
                }

                let valid = true;
                const particulars = [];
                document.querySelectorAll('#particularsBody tr').forEach((row, i) => {
                    const desc = row.querySelector('input[name*="[description]"]').value.trim();
                    const amt = row.querySelector('input[name*="[amount]"]').value.trim();
                    const fileInput = row.querySelector('input[type="file"]');
                    const files = fileInput.files;

                    if (desc && amt && files.length > 0) {
                        particulars.push({ description: desc, amount: amt });
                        Array.from(files).forEach(file => {
                            formData.append(`particular_attachment_${i}`, file);
                        });
                    } else if (desc || amt || files.length > 0) {
                        valid = false;
                    }
                });

                if (!valid || particulars.length === 0) {
                    return alert('Complete all particulars with description, amount and at least one attachment');
                }

                particulars.forEach((p, i) => {
                    formData.append(`particulars[${i}][description]`, p.description);
                    formData.append(`particulars[${i}][amount]`, p.amount);
                });

                fetch("{% url 'voucher_create_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken() },
                    body: formData
                })
                .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
                .then(data => {
                    document.getElementById('successMessage').textContent =
                        data.message || `Voucher ${data.voucher?.voucher_number || ''} created!`;
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    bootstrap.Modal.getInstance(voucherModal).hide();
                    form.reset();
                    document.getElementById('fileName').textContent = '';
                    document.getElementById('chequeFileName').textContent = '';
                    document.querySelectorAll('.particular-file-list').forEach(el => el.textContent = '');
                    tbody.innerHTML = `<tr>
                        <td><input type="text" class="form-control form-control-sm" name="particulars[0][description]" required></td>
                        <td><input type="number" step="0.01" class="form-control form-control-sm" name="particulars[0][amount]" required></td>
                        <td>
                            <input type="file" class="form-control form-control-sm"
       name="particular_attachment_0"
       multiple
       accept="image/*,application/pdf"
       required>

                            <div class="mt-1 text-muted small particular-file-list"></div>
                        </td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                    </tr>`;
                    index = 1;
                    document.getElementById('successOkBtn').onclick = () => {
    // Force full navigation to voucher list (this triggers fresh load with new voucher)
    window.location.href = "{% url 'voucher_list' %}";
};
                    
                })
                
            };
        }

           
        // === COMPANY DETAILS SAVE - FIXED & WORKING ===
        const companyForm = document.getElementById('companyDetailsForm');
        if (companyForm) {
            // Load existing company data when modal opens
            const companyModal = document.getElementById('companyDetailsModal');
            companyModal.addEventListener('show.bs.modal', function () {
                fetch("{% url 'company_detail_api' %}")
                    .then(r => r.json())
                    .then(data => {
                        if (data.id) {
                            document.getElementById('company_name').value = data.name || '';
                            document.getElementById('company_gst').value = data.gst_no || '';
                            document.getElementById('company_pan').value = data.pan_no || '';
                            document.getElementById('company_address').value = data.address || '';
                            document.getElementById('company_email').value = data.email || '';
                            document.getElementById('company_phone').value = data.phone || '';

                            const logoPreview = document.getElementById('currentLogoPreview');
                            const logoImg = document.getElementById('currentLogoImg');
                            if (data.logo) {
                                logoPreview.style.display = 'block';
                                logoImg.src = data.logo + '?t=' + Date.now();
                            } else {
                                logoPreview.style.display = 'none';
                            }
                            document.getElementById('noCompanyMessage').style.display = 'none';
                        } else {
                            // No company yet
                            companyForm.reset();
                            document.getElementById('currentLogoPreview').style.display = 'none';
                            document.getElementById('noCompanyMessage').style.display = 'block';
                        }
                    })
                    .catch(() => {
                        alert('Failed to load company details');
                    });
            });

            // Save form
            companyForm.onsubmit = function(e) {
                e.preventDefault();
                const fd = new FormData(this);

                fetch("{% url 'company_detail_api' %}", {
                    method: 'POST',
                    body: fd,
                    headers: {
                        'X-CSRFToken': window.csrfToken || "{{ csrf_token }}"
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        // Update logo preview if new logo uploaded
                        if (data.company && data.company.logo) {
                            const logoImg = document.getElementById('currentLogoImg');
                            if (logoImg) logoImg.src = data.company.logo + '?t=' + Date.now();
                            document.getElementById('currentLogoPreview').style.display = 'block';
                        }
                        document.getElementById('noCompanyMessage').style.display = 'none';
                        bootstrap.Modal.getInstance(companyModal).hide();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to save'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Failed to save company details.');
                });
            };
        }
        // === CHANGE PASSWORD MODAL - FIXED & WORKING 100% ===
        const passwordForm = document.getElementById('changePasswordForm');
        if (passwordForm) {
            passwordForm.onsubmit = function(e) {
                e.preventDefault();

                const errorDiv = document.getElementById('passwordError');
                const successDiv = document.getElementById('passwordSuccess');
                errorDiv.classList.add('d-none');
                successDiv.classList.add('d-none');

                const formData = new FormData(this);
                formData.append('csrfmiddlewaretoken', window.csrfToken || "{{ csrf_token }}");

                fetch("{% url 'password_change' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Success! Django redirected to password_change_done
                        successDiv.textContent = 'Password changed successfully!';
                        successDiv.classList.remove('d-none');
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                            passwordForm.reset();
                        }, 1500);
                    } else {
                        // Error - parse HTML to extract Django messages
                        return response.text().then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const errorMsg = doc.querySelector('.errorlist')?.textContent.trim() ||
                                           doc.querySelector('.alert-danger')?.textContent.trim() ||
                                           'Please correct the errors below.';
                            errorDiv.textContent = errorMsg;
                            errorDiv.classList.remove('d-none');
                        });
                    }
                })
                .catch(err => {
                    console.error(err);
                    errorDiv.textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('d-none');
                });
            };
        }
                // === UPDATE SIGNATURE MODAL ===
        const signatureForm = document.getElementById('updateSignatureForm');
        if (signatureForm) {
            signatureForm.onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const errorDiv = document.getElementById('signatureError');
                const successDiv = document.getElementById('signatureSuccess');
                errorDiv.classList.add('d-none');
                successDiv.classList.add('d-none');

                fetch("{% url 'user_update_api' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': window.csrfToken || "{{ csrf_token }}"
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.message) {
                        successDiv.textContent = 'Signature updated successfully!';
                        successDiv.classList.remove('d-none');
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('updateSignatureModal')).hide();
                            location.reload(); // Refresh to show new signature in navbar/print
                        }, 1200);
                    } else {
                        errorDiv.textContent = data.error || 'Failed to update signature.';
                        errorDiv.classList.remove('d-none');
                    }
                })
                .catch(() => {
                    errorDiv.textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('d-none');
                });
            };
        }
    });
    </script>

   
    {% block extra_js %}{% endblock %}
</body>
</html>