{% load static %}
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11/font/bootstrap-icons.css">
    <style>
        .btn-warning { min-width: 180px; }
        .btn-lg { min-height: 50px; }
        .file-name { font-size: 0.9em; color: #555; }
        /* WIDER CREATE VOUCHER MODAL */
        #createVoucherModal .modal-dialog {
            max-width: 90vw !important;
            width: 1400px;
            margin: 1.75rem auto;
        }
        @media (max-width: 1500px) {
            #createVoucherModal .modal-dialog { width: 95vw; }
        }
        #createVoucherModal .modal-body { max-height: 75vh; overflow-y: auto; }
        #particularsTable th, #particularsTable td { vertical-align: middle; }
        .navbar .dropdown-toggle::after { display: none; }
        .grip-handle { cursor: move; color: #6c757d; }
        .list-group-item:hover .grip-handle { color: #495057; }
    </style>
    <script>window.csrfToken = "{{ csrf_token }}";</script>
</head>
<body>
    {% now "Y-m-d" as today %}
    <script>window.today = "{{ today }}";</script>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand p-0" href="{% url 'home' %}">
                {% if company_logo_url %}
                    <img src="{{ company_logo_url }}" 
                        alt="Company Logo" 
                        class="img-fluid" 
                        style="height: 45px; width: auto; max-width: 200px; object-fit: contain;">
                {% endif %}
            </a>

            
            <div class="collapse navbar-collapse" id="navbarContent">
                {% if request.resolver_match.url_name == 'voucher_detail' %}
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'voucher_list' %}">Voucher List</a>
                    </li>
                </ul>
                {% endif %}

                <ul class="navbar-nav ms-auto align-items-center">
    {% if user.is_authenticated %}
        
        <!-- ‚úÖ COMPANY SWITCHER DROPDOWN -->
        {% if user_companies %}
        <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle d-flex align-items-center" 
               href="#" 
               role="button" 
               data-bs-toggle="dropdown"
               style="border: 1px solid #dee2e6; border-radius: 8px; padding: 0.5rem 1rem; background: white;">
                {% if active_company %}
                    {% if active_company.logo %}
                    <img src="{{ active_company.logo.url }}" 
                         alt="{{ active_company.name }}" 
                         style="width: 24px; height: 24px; object-fit: contain; margin-right: 8px; border-radius: 4px;">
                    {% else %}
                    <i class="bi bi-building me-2 text-primary"></i>
                    {% endif %}
                    <span class="fw-semibold">{{ active_company.name }}</span>
                {% else %}
                    <i class="bi bi-building me-2"></i>
                    <span>Select Company</span>
                {% endif %}
                <i class="bi bi-chevron-down ms-2 small"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 280px;">
                {% for membership in user_companies %}
                <li>
                    <form method="post" action="{% url 'set_company' %}" class="d-inline w-100">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" 
                                name="company_id" 
                                value="{{ membership.company.id }}" 
                                class="dropdown-item {% if active_company.id == membership.company.id %}active{% endif %} py-2">
                            <div class="d-flex align-items-center">
                                {% if membership.company.logo %}
                                <img src="{{ membership.company.logo.url }}" 
                                     alt="" 
                                     style="width: 32px; height: 32px; object-fit: contain; margin-right: 10px; border-radius: 4px;">
                                {% else %}
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-building text-white small"></i>
                                </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <div class="fw-semibold">{{ membership.company.name }}</div>
                                    <small class="text-muted">{{ membership.group }}</small>
                                </div>
                                {% if active_company.id == membership.company.id %}
                                <i class="bi bi-check-circle-fill text-success ms-2"></i>
                                {% endif %}
                            </div>
                        </button>
                    </form>
                </li>
                {% if not forloop.last %}
                <li><hr class="dropdown-divider"></li>
                {% endif %}
                {% endfor %}
            </ul>
        </li>
        {% endif %}
        
        <!-- USER DROPDOWN (existing) -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-primary fw-bold d-flex align-items-center gap-2"
               href="#" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle"></i>
                {{ user.username }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow">
                {% if user.is_superuser %}
                <li><a class="dropdown-item" href="{% url 'admin:index' %}">Admin Panel</a></li>
                <li><hr class="dropdown-divider"></li>
                {% endif %}

                <!-- CHANGE PASSWORD -->
                <li>
                    <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        <i class="bi bi-key me-2"></i>Change Password
                    </a>
                </li>
                
                <!-- UPDATE MOBILE -->
                <li>
                    <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#updateMobileModal">
                        <i class="bi bi-phone me-2"></i>Update Mobile Number
                    </a>
                </li>
                
                <!-- UPDATE SIGNATURE -->
                <li>
                    <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#updateSignatureModal">
                        <i class="bi bi-pen me-2"></i>Update Signature
                    </a>
                </li>
                
                <!-- LOGOUT -->
                <li>
                    <a class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#logoutModal">
                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                    </a>
                </li>
            </ul>
        </li>
    {% else %}
        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
    {% endif %}
</ul>

            </div>
        </div>
    </nav>
<!-- FLASH MESSAGES - BOOTSTRAP MODAL VERSION (FIXED ACCESSIBILITY) -->
{% if messages %}
    {% for message in messages %}
    <div class="modal fade" id="messageModal{{ forloop.counter }}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header {% if message.tags == 'error' or message.tags == 'danger' %}bg-danger{% elif message.tags == 'warning' %}bg-warning{% elif message.tags == 'success' %}bg-success{% else %}bg-info{% endif %} text-white">
                    <h5 class="modal-title">
                        {% if message.tags == 'error' or message.tags == 'danger' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Access Denied
                        {% elif message.tags == 'warning' %}
                            <i class="bi bi-exclamation-circle-fill me-2"></i>Warning
                        {% elif message.tags == 'success' %}
                            <i class="bi bi-check-circle-fill me-2"></i>Success
                        {% else %}
                            <i class="bi bi-info-circle-fill me-2"></i>Information
                        {% endif %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="mb-0 fs-6">{{ message }}</p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" 
                            class="btn {% if message.tags == 'error' or message.tags == 'danger' %}btn-danger{% elif message.tags == 'warning' %}btn-warning{% elif message.tags == 'success' %}btn-success{% else %}btn-info{% endif %} px-5 message-ok-btn" 
                            data-bs-dismiss="modal"
                            data-modal-id="messageModal{{ forloop.counter }}">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modalEl{{ forloop.counter }} = document.getElementById('messageModal{{ forloop.counter }}');
            const modal{{ forloop.counter }} = new bootstrap.Modal(modalEl{{ forloop.counter }});
            
            // Show modal
            modal{{ forloop.counter }}.show();
            
            // ‚úÖ FIX: Remove focus from button before modal closes
            modalEl{{ forloop.counter }}.addEventListener('hide.bs.modal', function(e) {
                const okBtn = this.querySelector('.message-ok-btn');
                if (okBtn && document.activeElement === okBtn) {
                    okBtn.blur(); // Remove focus before modal hides
                }
            });
        });
    </script>
    {% endfor %}
{% endif %}
   
   
    <div class="container mt-4">{% block content %}{% endblock %}</div>
    <!-- LOGOUT MODAL -->
    {% if user.is_authenticated %}
    <div class="modal fade" id="logoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><p>Are you sure you to log out?</p></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'logout' %}" class="d-inline">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <button type="submit" class="btn btn-danger">Yes, Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- SUCCESS MODAL (FIXED ACCESSIBILITY) -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title d-flex align-items-center gap-2">Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="mb-0 fs-5" id="successMessage">Voucher created successfully!</p>
            </div>
            <div class="modal-footer justify-content-center border-0">
                <button type="button" class="btn btn-success px-5" id="successOkBtn">OK</button>
            </div>
        </div>
    </div>
</div>

    <!-- CHANGE PASSWORD MODAL -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock me-2"></i>Change Password
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="old_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="new_password1" required minlength="8">
                        <small class="text-muted">Minimum 8 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="new_password2" required>
                    </div>
                    <div id="passwordError" class="alert alert-danger d-none"></div>
                    <div id="passwordSuccess" class="alert alert-success d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Update Password
                    </button>
                    
                </div>
            </form>
        </div>
    </div>
</div>
<!-- UPDATE SIGNATURE MODAL -->
<div class="modal fade" id="updateSignatureModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pen me-2"></i>Update Signature
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateSignatureForm" enctype="multipart/form-data">
                <div class="modal-body text-center">
                    {% if user.userprofile.signature %}
                        <div class="mb-4">
                            <p class="text-muted small mb-2">Current Signature:</p>
                            <img src="{{ user.userprofile.signature.url }}?t={{ user.userprofile.signature.url|cut:'.'|length }}" 
                                 alt="Current Signature" 
                                 class="border rounded p-2 bg-white" 
                                 style="max-height: 100px;">
                        </div>
                    {% else %}
                        <p class="text-muted mb-4">No signature uploaded yet.</p>
                    {% endif %}

                    <div class="mb-3">
                        <label class="form-label">Upload New Signature <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" name="signature" accept="image/png,image/jpeg" required>
                        <small class="text-muted d-block mt-2">
                            PNG or JPG ‚Ä¢ Transparent background recommended ‚Ä¢ Max 2MB
                        </small>
                    </div>

                    <div id="signatureError" class="alert alert-danger d-none mt-3"></div>
                    <div id="signatureSuccess" class="alert alert-success d-none mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> Update Signature
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- UPDATE MOBILE NUMBER MODAL -->
<div class="modal fade" id="updateMobileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-phone me-2"></i>Update Mobile Number
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateMobileForm">
                <div class="modal-body">
                    {% if user.userprofile.mobile %}
                        <div class="mb-4 text-center">
                            <p class="text-muted small mb-2">Current Mobile Number:</p>
                            <strong class="fs-5">{{ user.userprofile.mobile }}</strong>
                        </div>
                    {% else %}
                        <p class="text-muted mb-4 text-center">No mobile number set yet.</p>
                    {% endif %}
                    <div class="mb-3">
                        <label for="new_mobile" class="form-label">New Mobile Number <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="new_mobile"
                               name="mobile"
                               maxlength="10"
                               required>
                        
                    </div>
                    <div id="mobileError" class="alert alert-danger d-none mt-3"></div>
                    <div id="mobileSuccess" class="alert alert-success d-none mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-check-lg"></i> Update Mobile
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    <!-- CREATE DESIGNATION MODAL -->
    <div class="modal fade" id="createDesignationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="createDesignationForm">
                    <div class="modal-header bg-light">
                        <div>
                            <h5 class="modal-title fw-semibold mb-0">
                                <i class="bi bi-person-badge me-2 text-primary"></i>
                                Create New Designation
                            </h5>
                           
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="designation_name" class="form-label">Designation Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="designation_name" name="name" required maxlength="100">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- CREATE USER MODAL (SUPERUSER ONLY) -->
{% if user.is_superuser %}
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createUserForm" enctype="multipart/form-data">
               <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title fw-semibold mb-0">
                            <i class="bi bi-person-plus me-2 text-primary"></i>
                            Create New User
                        </h5>
                        
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="user_username" class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="user_username" name="username" required maxlength="150">
                    </div>
                    <div class="mb-3">
                        <label for="user_password" class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="user_password" name="password" required minlength="8">
                    </div>

                    <!-- Signature Upload -->
                    <div class="mb-3">
                        <label for="user_signature" class="form-label">Signature (Optional)</label>
                        <input type="file" class="form-control form-control-sm" id="user_signature" name="signature" accept="image/png,image/jpeg">
                        <div class="form-text">Upload a clear PNG/JPG of signature (transparent background preferred).</div>
                    </div>
                    
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
    <!-- CONTROL APPROVAL MODAL -->
    {% if user.is_superuser %}
    <div class="modal fade" id="approvalControlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title fw-semibold mb-0">
                           <i class="bi bi-sliders me-2 text-primary"></i>


                            Control Approval
                        </h5>
                        
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="approvalLevelsList" class="list-group"></div>
                    <div class="mt-3">
                        <select id="addDesignationSelect" class="form-select">
                            <option value="">-- Add Designation --</option>
                        </select>
                        <button id="addDesignationBtn" class="btn btn-sm btn-outline-primary mt-2">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveApprovalControl">Save Order</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- USER CONTROL MODAL (SUPERUSER ONLY) -->
{% if user.is_superuser %}
<div class="modal fade" id="userControlModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <div>
                    <h5 class="modal-title fw-semibold mb-0">
                        <i class="bi bi-people me-2 text-primary"></i>
                        User Control Panel
                    </h5>
                
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle" id="userControlTable">
                        <thead class="table-light">
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>    
                        <tbody>
                            {% for u in all_users %}
                            <tr data-user-id="{{ u.id }}">
                                <td>{{ u.username }}</td>
                                <td>
                                    <span class="badge bg-{{ u.is_active|yesno:'success,danger' }}">
                                        {{ u.is_active|yesno:'Active,Disabled' }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary edit-user-btn"
                                            data-id="{{ u.id }}"
                                            data-username="{{ u.username }}"
                                            data-active="{{ u.is_active|yesno:'true,false' }}"
                                            data-signature="{% if u.userprofile.signature %}{{ u.userprofile.signature.url }}{% endif %}">
                                        Edit
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-muted">No users found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
    <!-- EDIT USER MODAL (inside User Control) -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_user_id">
                    <div class="mb-3">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit_username" required maxlength="150">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_user_active">
                            <label class="form-check-label" for="edit_user_active">Active</label>
                        </div>
                    </div>
                    
                    <!-- Signature Upload + Preview -->
                    <div class="mb-3">
                        <label class="form-label">Signature</label>
                        <input type="file" class="form-control form-control-sm" id="edit_user_signature" name="signature" accept="image/png,image/jpeg">
                        <div class="form-text">Leave blank to keep current signature.</div>
                        <div id="currentSignaturePreview" class="mt-2 text-center" style="display:none;">
                            <p class="small text-muted mb-1">Current Signature:</p>
                            <img id="currentSignatureImg" src="" alt="Current Signature" style="max-height: 60px; border: 1px dashed #ccc; padding: 5px;">
                        </div>
                    </div>
                    
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
   
    

<!-- ACCOUNT CONTROL MODAL (SUPERUSER ONLY) -->
{% if user.is_superuser %}
<div class="modal fade" id="accountControlModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <div>
                    <h5 class="modal-title fw-semibold mb-0">
                        <i class="bi bi-bank me-2 text-primary"></i>
                        Bank Account Management
                    </h5>
                    
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

           
            <div class="modal-body">
                
                <!-- Add Account Form -->
                <div class="card border-success mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-plus-circle-fill text-success me-2"></i>Add New Account</h6>
                    </div>
                    <div class="card-body">
                        <form id="addAccountForm" class="row g-3">
                            <div class="col-md-5">
                                <label class="form-label">Bank Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" placeholder="e.g. State Bank of India" id="bank_name" required>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Account Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" placeholder="e.g. 1234567890" id="account_number" required>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Accounts List -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>All Bank Accounts</h6>
                    </div>
                    <div class="card-body p-0">
                        <!-- Loading State -->
                        <div id="accountsLoading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading accounts...</p>
                        </div>

                        <!-- Accounts Table -->
                        <div id="accountsContent" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0" id="accountTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 60px;">Status</th>
                                            <th>Bank Name</th>
                                            <th>Account Number</th>
                                            <th style="width: 120px;">Added On</th>
                                            <th style="width: 180px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="accountsEmpty" style="display: none;" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">No bank accounts added yet for this company</p>
                        </div>

                        <!-- Error State -->
                        <div id="accountsError" style="display: none;" class="text-center py-5">
                            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                            <p class="text-danger mt-3" id="accountsErrorMsg"></p>
                            <button class="btn btn-outline-danger btn-sm" onclick="loadAccountsModal()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Retry
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// =============================================
// ACCOUNT CONTROL MODAL - COMPLETE WITH ENABLE/DISABLE
// =============================================

const accountModal = document.getElementById('accountControlModal');
if (accountModal) {
    const tableBody = accountModal.querySelector('#accountTable tbody');
    const addForm = accountModal.querySelector('#addAccountForm');
    const loading = document.getElementById('accountsLoading');
    const content = document.getElementById('accountsContent');
    const empty = document.getElementById('accountsEmpty');
    const error = document.getElementById('accountsError');
    
    // ‚úÖ LOAD ALL ACCOUNTS (active + inactive) FOR MANAGEMENT
    function loadAccountsModal() {
        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';
        error.style.display = 'none';

        fetch('/api/accounts/all/', {
            headers: {
                'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        })
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(data => {
            console.log('‚úÖ Accounts loaded:', data);
            tableBody.innerHTML = '';
            
            if (!data.accounts || data.accounts.length === 0) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            
            data.accounts.forEach(acc => {
                const tr = document.createElement('tr');
                tr.className = acc.is_active ? '' : 'table-secondary';
                tr.innerHTML = `
                    <td class="text-center">
                        <span class="badge bg-${acc.is_active ? 'success' : 'secondary'}">
                            ${acc.is_active ? '‚úì Active' : '‚úó Inactive'}
                        </span>
                    </td>
                    <td>
                        <strong class="${acc.is_active ? '' : 'text-muted'}">${escapeHtml(acc.bank_name)}</strong>
                    </td>
                    <td>
                        <code class="${acc.is_active ? '' : 'text-muted'}">${escapeHtml(acc.account_number)}</code>
                    </td>
                    <td>
                        <small class="text-muted">${acc.created_at}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-${acc.is_active ? 'warning' : 'success'} toggle-account" 
                                    data-id="${acc.id}"
                                    title="${acc.is_active ? 'Disable' : 'Enable'} Account">
                                <i class="bi bi-${acc.is_active ? 'pause' : 'play'}-circle"></i>
                                ${acc.is_active ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-outline-danger delete-account" 
                                    data-id="${acc.id}"
                                    data-bank="${escapeHtml(acc.bank_name)}"
                                    data-account="${escapeHtml(acc.account_number)}"
                                    title="Delete Account">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            
            loading.style.display = 'none';
            content.style.display = 'block';
        })
        .catch(err => {
            console.error('‚ùå Error loading accounts:', err);
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('accountsErrorMsg').textContent = 
                'Failed to load accounts: ' + err.message;
        });
    }
    
    // ‚úÖ LOAD ACCOUNTS WHEN MODAL OPENS
    accountModal.addEventListener('show.bs.modal', function() {
        console.log('üîÑ Loading bank accounts for active company...');
        loadAccountsModal();
    });
    
    // ‚úÖ ADD ACCOUNT FORM SUBMISSION
    addForm.onsubmit = e => {
        e.preventDefault();
        const bank = document.getElementById('bank_name').value.trim();
        const acc = document.getElementById('account_number').value.trim();
        
        if (!bank || !acc) {
            alert('Please fill in both bank name and account number');
            return;
        }
        
        const submitBtn = addForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding...';
        
        fetch('/api/accounts/create/', {
            method: 'POST',
            headers: { 
                'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ 
                bank_name: bank, 
                account_number: acc 
            })
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => {
                    throw new Error(err.error || 'Failed to create account');
                });
            }
            return r.json();
        })
        .then(d => {
            if (d.id) {
                alert(d.message || 'Account added successfully!');
                addForm.reset();
                loadAccountsModal(); // ‚úÖ Reload the table
                
                // ‚úÖ ALSO reload accounts in voucher creation dropdown if modal is open
                const voucherModal = document.getElementById('createVoucherModal');
                if (voucherModal && voucherModal.classList.contains('show')) {
                    loadAccounts(); // This reloads dropdown in voucher modal
                }
            } else {
                throw new Error(d.error || 'Failed to create account');
            }
        })
        .catch(err => {
            console.error('‚ùå Error creating account:', err);
            alert('Error: ' + err.message);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    };
    
    // ‚úÖ TOGGLE ACCOUNT ACTIVE/INACTIVE
    tableBody.onclick = e => {
        const toggleBtn = e.target.closest('.toggle-account');
        const deleteBtn = e.target.closest('.delete-account');
        
        if (toggleBtn) {
            const id = toggleBtn.dataset.id;
            const row = toggleBtn.closest('tr');
            const isActive = toggleBtn.querySelector('i').classList.contains('bi-pause-circle');
            
            if (!confirm(`${isActive ? 'Disable' : 'Enable'} this account?`)) return;
            
            toggleBtn.disabled = true;
            toggleBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            fetch(`/api/accounts/${id}/toggle/`, {
                method: 'POST',
                headers: { 
                    'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.error || 'Failed to toggle account');
                    });
                }
                return r.json();
            })
            .then(data => {
                alert(data.message || 'Account status updated');
                loadAccountsModal(); // ‚úÖ Reload table
                
                // ‚úÖ Reload voucher dropdown if open
                const voucherModal = document.getElementById('createVoucherModal');
                if (voucherModal && voucherModal.classList.contains('show')) {
                    loadAccounts();
                }
            })
            .catch(err => {
                console.error('‚ùå Error toggling account:', err);
                alert('Error: ' + err.message);
                toggleBtn.disabled = false;
                toggleBtn.innerHTML = isActive ? 
                    '<i class="bi bi-pause-circle"></i> Disable' : 
                    '<i class="bi bi-play-circle"></i> Enable';
            });
        }
        
        if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            const bankName = deleteBtn.dataset.bank;
            const accountNum = deleteBtn.dataset.account;
            
            if (!confirm(`Permanently delete account ${bankName} / ${accountNum}?\n\nThis action cannot be undone.`)) return;
            
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            fetch(`/api/accounts/delete/${id}/`, {
                method: 'DELETE',
                headers: { 
                    'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.error || 'Failed to delete');
                    });
                }
                return r.json();
            })
            .then(() => {
                alert('Account deleted successfully');
                loadAccountsModal(); // ‚úÖ Reload table
                
                // ‚úÖ Reload voucher dropdown if open
                const voucherModal = document.getElementById('createVoucherModal');
                if (voucherModal && voucherModal.classList.contains('show')) {
                    loadAccounts();
                }
            })
            .catch(err => {
                console.error('‚ùå Error deleting account:', err);
                alert('Error: ' + err.message);
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
            });
        }
    };
}

// Helper function for escaping HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endif %}
    {% if user.is_superuser %}
<!-- USER RIGHTS MODAL -->
<div class="modal fade" id="userRightsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <div>
                    <h5 class="modal-title fw-semibold mb-0">
                        <i class="bi bi-shield-lock me-2 text-primary"></i>
                        User Rights & Permissions
                    </h5>
                    
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <!-- Loading State -->
                <div id="userRightsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-3">Loading user permissions...</p>
                </div>

                <!-- Main Content -->
                <div id="userRightsContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 12%;">Username</th>
                                    <th style="width: 10%;">Group</th>
                                    <th style="width: 12%;">Designation</th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-file-earmark-plus text-primary"></i><br>
                                        <small>Create<br>Voucher</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-pencil-square text-warning"></i><br>
                                        <small>Edit<br>Voucher</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-list-ul text-info"></i><br>
                                        <small>Voucher<br>List</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-eye text-secondary"></i><br>
                                        <small>Voucher<br>Detail</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-printer text-dark"></i><br>
                                        <small>Print<br>Voucher</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-calendar-plus text-success"></i><br>
                                        <small>Create<br>Function</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-pencil text-info"></i><br>
                                        <small>Edit<br>Function</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-trash text-danger"></i><br>
                                        <small>Delete<br>Function</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-calendar3 text-primary"></i><br>
                                        <small>Function<br>List</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-eye-fill text-success"></i><br>
                                        <small>Function<br>Detail</small>
                                    </th>
                                    <th class="text-center" style="width: 6%;">
                                        <i class="bi bi-printer-fill text-secondary"></i><br>
                                        <small>Print<br>Function</small>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="userRightsTableBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Error State -->
                <div id="userRightsError" class="text-center py-5" style="display: none;">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <p class="text-danger mt-3" id="userRightsErrorMessage"></p>
                    <button class="btn btn-outline-danger btn-sm" onclick="loadUserRights()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry
                    </button>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <div class="me-auto">
                    
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ PASS CURRENT USER ID TO JAVASCRIPT -->
<script>
    window.CURRENT_USER_ID = "{{ user.id }}";
</script>

<script>
// ===================================
// USER RIGHTS MANAGEMENT - COMPLETE
// ===================================

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('userRightsModal');
    if (!modal) return;

    // Load data when modal opens
    modal.addEventListener('show.bs.modal', function() {
        loadUserRights();
    });
});

function loadUserRights() {
    const loading = document.getElementById('userRightsLoading');
    const content = document.getElementById('userRightsContent');
    const error = document.getElementById('userRightsError');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';

    fetch('/api/user-rights/', {
        headers: {
            'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        }
    })
    .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    })
    .then(data => {
        console.log('‚úÖ User rights loaded:', data);
        renderUserRightsTable(data.users);
        loading.style.display = 'none';
        content.style.display = 'block';
    })
    .catch(err => {
        console.error('‚ùå Error loading user rights:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
        document.getElementById('userRightsErrorMessage').textContent = 
            'Failed to load user rights: ' + err.message + '. Check console (F12) for details.';
    });
}

function renderUserRightsTable(users) {
    const tbody = document.getElementById('userRightsTableBody');
    tbody.innerHTML = '';

    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted py-4">No users found</td></tr>';
        return;
    }

    users.forEach(user => {
        const row = document.createElement('tr');
        const isCurrentUser = user.id === window.CURRENT_USER_ID;
        
        row.innerHTML = `
            <td>
                <strong>${escapeHtml(user.username)}</strong>
                ${isCurrentUser ? '<span class="badge bg-info ms-2">You</span>' : ''}
            </td>
            <td>
                <span class="badge bg-${getGroupColor(user.group)}">${escapeHtml(user.group)}</span>
            </td>
            <td>
                <small class="text-muted">${escapeHtml(user.designation)}</small>
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_create_voucher', user.permissions.can_create_voucher)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_edit_voucher', user.permissions.can_edit_voucher)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_view_voucher_list', user.permissions.can_view_voucher_list)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_view_voucher_detail', user.permissions.can_view_voucher_detail)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_print_voucher', user.permissions.can_print_voucher)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_create_function', user.permissions.can_create_function)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_edit_function', user.permissions.can_edit_function)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_delete_function', user.permissions.can_delete_function)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_view_function_list', user.permissions.can_view_function_list)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_view_function_detail', user.permissions.can_view_function_detail)}
            </td>
            <td class="text-center">
                ${createPermissionCheckbox(user.id, 'can_print_function', user.permissions.can_print_function)}
            </td>
        `;
        tbody.appendChild(row);
    });

    // Attach event listeners
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handlePermissionChange);
    });
    
    console.log('‚úÖ Rendered ' + users.length + ' users');
}
function createPermissionCheckbox(userId, permission, checked) {
    return `
        <div class="form-check d-inline-block">
            <input class="form-check-input permission-checkbox" 
                   type="checkbox" 
                   data-user-id="${userId}"
                   data-permission="${permission}"
                   ${checked ? 'checked' : ''}>
        </div>
    `;
}

function getGroupColor(group) {
    switch(group) {
        case 'Admin Staff': return 'primary';
        case 'Accountants': return 'success';
        default: return 'secondary';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function handlePermissionChange(event) {
    const checkbox = event.target;
    const userId = checkbox.dataset.userId;
    const permission = checkbox.dataset.permission;
    const isChecked = checkbox.checked;

    // Disable checkbox while saving
    checkbox.disabled = true;

    // Collect ALL current checkbox states for this user
    const row = checkbox.closest('tr');
    const allCheckboxes = row.querySelectorAll('.permission-checkbox');
    
    const permissions = {};
    allCheckboxes.forEach(cb => {
        permissions[cb.dataset.permission] = cb.checked;
    });

    console.log('üíæ Saving permissions for user ' + userId + ':', permissions);

    fetch('/api/user-rights/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            user_id: userId,
            permissions: permissions
        })
    })
    .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    })
    .then(data => {
        console.log('‚úÖ Permission updated:', data);
        checkbox.disabled = false;
        
        // Flash the row green
        row.style.transition = 'background-color 0.3s';
        row.style.backgroundColor = '#d4edda';
        setTimeout(() => {
            row.style.backgroundColor = '';
        }, 800);
    })
    .catch(err => {
        console.error('‚ùå Error updating permission:', err);
        // Revert checkbox on error
        checkbox.checked = !isChecked;
        checkbox.disabled = false;
        alert('Failed to update permission: ' + err.message);
    });
}
</script>
{% endif %}


    
    <!-- CREATE VOUCHER MODAL - WORKS FOR ACCOUNTANTS, ADMIN STAFF & SUPERUSER -->
    {% if user.is_authenticated %}
        {% with user_group=user.groups.all.0.name %}
            {% if user_group == 'Accountants' or user_group == 'Admin Staff' or user.is_superuser %}
                <div class="modal fade" id="createVoucherModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Voucher</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createVoucherForm" enctype="multipart/form-data">
                                    <!-- 1. Voucher Date - Top Right -->
                                    <div class="text-end mb-4">
                                        <div class="d-inline-block" style="width: 180px;">
                                            <label for="voucher_date" class="form-label fw-bold text-primary">
                                                Voucher Date <span class="text-danger">*</span>
                                            </label>
                                            <input type="date" class="form-control form-control-sm" id="voucher_date" name="voucher_date" max="{{ today }}" required>
                                        </div>
                                    </div>
                                    <!-- 2. Title (SUPER SMALL) + Pay To (Full) -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-2">
                                            <label for="name_title" class="form-label">Title <span class="text-danger">*</span></label>
                                            <select class="form-select form-select-sm" id="name_title" name="name_title" required>
                                                <option value="MR">Mr.</option>
                                                <option value="MRS">Mrs.</option>
                                                <option value="MS">Ms.</option>
                                            </select>
                                        </div>
                                        <div class="col-md-10">
                                            <label for="pay_to" class="form-label">Pay To <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="pay_to" name="pay_to" required placeholder="Enter full name"  oninput="this.value = this.value.toUpperCase();">
                                        </div>
                                    </div>
                                    <!-- 3. Payment Type + CHEQUE FIELDS IN ONE ROW -->
                                    <div class="mb-3">
                                        <div class="row g-3 align-items-end">
                                            <!-- Payment Type -->
                                            <div class="col-md-3">
                                                <label for="payment_type" class="form-label">Payment Type <span class="text-danger">*</span></label>
                                                <select class="form-select form-select-sm" id="payment_type" name="payment_type" required>
                                                    <option value="CASH">Cash</option>
                                                    <option value="CHEQUE">Cheque</option>
                                                    <option value="PETTY_CASH">Petty Cash</option>
                                                </select>
                                            </div>
                                            <!-- Cheque Number -->
                                            <div class="col-md-2" id="chequeNumberField" style="display:none;">
                                                <label for="cheque_number" class="form-label">Cheque Number <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" id="cheque_number" name="cheque_number" placeholder="e.g. 123456" maxlength="20">
                                            </div>
                                            <!-- Cheque Date -->
                                            <div class="col-md-2" id="chequeDateField" style="display:none;">
                                                <label for="cheque_date" class="form-label">Cheque Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control form-control-sm" id="cheque_date" name="cheque_date" max="{{ today }}">
                                            </div>
                                            <!-- Account Details - REQUIRED, NO NULL -->
                                            <div class="col-md-3" id="accountDetailsField" style="display:none;">
                                                <label for="account_details" class="form-label">Account Details <span class="text-danger">*</span></label>
                                                <select class="form-select form-select-sm" id="account_details" name="account_details" required>
                                                    <!-- Options filled by loadAccounts() -->
                                                </select>
                                            </div>
                                            <!-- Cheque Attachment (NOW MULTIPLE) -->
                                            <!-- CHEQUE ATTACHMENTS - CORRECT -->
<div class="col-md-2" id="chequeAttachmentField" style="display:none;">
    <label class="form-label">Cheque Attachments <span class="text-danger">*</span></label>
    <div id="chequeFileName" class="text-muted small mt-1"></div>

    <input type="file"
           class="form-control form-control-sm"
           name="cheque_attachments"
           id="cheque_attachments"
           multiple
           accept="image/*,application/pdf">
    
</div>
                                        </div>
                                    </div>
                                    <!-- 5. Main Attachment (NOW MULTIPLE & OPTIONAL) -->
                                    <!-- MAIN ATTACHMENTS - CORRECT -->
<div class="mb-4" style="max-width: 500px;">
    <label class="form-label">Main Attachments</label>
    <input type="file"
       id="main_attachments"
       name="main_attachments"
       class="form-control form-control-sm"
       multiple
       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
           <div id="fileName" class="text-muted small mt-1"></div>

</div>
                                    <!-- REMOVED: EMAIL & PHONE FROM VOUCHER FORM -->
                                    <hr class="my-4">
                                    <!-- PARTICULARS -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Particulars <span class="text-danger">*</span></label>
                                        <table class="table table-sm table-bordered" id="particularsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th width="40%">Description</th>
                                                    <th width="20%">Amount</th>
                                                    <th width="30%">Attachments </th>
                                                    <th width="10%"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="particularsBody">
                                                <tr>
                                                    <td><input type="text" class="form-control form-control-sm" name="particulars[0][description]" required  oninput="this.value = this.value.toUpperCase();"></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm" name="particulars[0][amount]" required></td>
                                                    <td>
                                                        <input type="file" class="form-control form-control-sm"
                                                            name="particular_attachment_0"
                                                            multiple
                                                            accept="image/*,application/pdf"
                                                            required>

                                                        <div class="mt-1 text-muted small particular-file-list"></div>
                                                    </td>
                                                    <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <button type="button" class="btn btn-sm btn-primary" id="addParticular">Add Row</button>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">Submit Voucher</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endwith %}
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        
    document.addEventListener('DOMContentLoaded', function () {
        const getCsrfToken = () => window.csrfToken;
     // -------------------------------------------------
// GLOBAL: Load bank accounts into the dropdown (NO NULL)
// -------------------------------------------------
function loadAccounts() {
    const select = document.getElementById('account_details');
    if (!select) return;

    select.innerHTML = '<option value="">Loading...</option>';
    
    fetch("{% url 'account_list' %}", {
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        return response.json();
    })
    .then(accounts => {
        select.innerHTML = '';
        
        if (!Array.isArray(accounts) || accounts.length === 0) {
            const opt = document.createElement('option');
            opt.value = "";
            opt.textContent = "-- No Accounts for This Company --";
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            return;
        }

        // Placeholder
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "-- Select Account --";
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        accounts.forEach(acc => {
            const opt = document.createElement('option');
            opt.value = acc.value;
            opt.textContent = acc.label;
            select.appendChild(opt);
        });
    })
    .catch(error => {
        console.error('Error loading accounts:', error);
        select.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "-- Load Failed --";
        opt.disabled = true;
        opt.selected = true;
        select.appendChild(opt);
    });
}

// ‚úÖ LOAD ACCOUNTS ONLY IF COMPANY IS SELECTED
const ACTIVE_COMPANY_ID = "{{ request.session.active_company_id|default:'' }}";
if (ACTIVE_COMPANY_ID) {
    loadAccounts();
}

// -------------------------------------------------
// Auto-fill date
// -------------------------------------------------
const dateInput = document.getElementById('voucher_date');
if (dateInput) {
    dateInput.value = window.today;
    dateInput.max = window.today;
}
        // === CREATE USER ===
const userForm = document.getElementById('createUserForm');
if (userForm) {
    userForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('username', document.getElementById('user_username').value.trim());
        formData.append('password', document.getElementById('user_password').value);
        
        const signature = document.getElementById('user_signature').files[0];
        if (signature) formData.append('signature', signature);
        
        fetch("{% url 'user_create_api' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() },
            body: formData
        })
        .then(r => r.json())
        .then(d => {
            if (d.id) {
                alert(d.message); // Shows message about assigning to companies
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                userForm.reset();
                location.reload();
            } else alert('Error: ' + (d.error || 'Failed'));
        });
    });
}
        // === APPROVAL CONTROL ===
        const controlModal = document.getElementById('approvalControlModal');
        if (controlModal) {
            const list = document.getElementById('approvalLevelsList');
            const select = document.getElementById('addDesignationSelect');
            const addBtn = document.getElementById('addDesignationBtn');
            const saveBtn = document.getElementById('saveApprovalControl');
            let allDesignations = [], currentLevels = [];
            function render() {
                list.innerHTML = '';
                currentLevels.forEach((lvl, idx) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.draggable = true;
                    item.dataset.id = lvl.id;
                    item.innerHTML = `
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-grip-vertical grip-handle"></i>
                            <strong>${idx + 1}.</strong>
                            <span>${lvl.name}</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger ms-2 remove-level">Remove</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
                const used = currentLevels.map(l => l.id);
                select.innerHTML = '<option value="">-- Add Designation --</option>';
                allDesignations.forEach(d => {
                    if (!used.includes(d.id)) {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.name;
                        select.appendChild(opt);
                    }
                });
            }
            fetch("{% url 'approval_control_api' %}").then(r => r.json()).then(data => {
                allDesignations = data.all_designations;
                currentLevels = data.levels.map(l => ({ id: l.id, name: l.name }));
                render();
            });
            let dragged;
            list.addEventListener('dragstart', e => { dragged = e.target.closest('.list-group-item'); });
            list.addEventListener('dragover', e => e.preventDefault());
            list.addEventListener('drop', e => {
                e.preventDefault();
                const after = [...list.querySelectorAll('.list-group-item')].reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset, element: child };
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
                if (after == null) list.appendChild(dragged);
                else list.insertBefore(dragged, after);
            });
            addBtn.onclick = () => {
                const id = parseInt(select.value);
                const name = select.selectedOptions[0].textContent;
                if (id) { currentLevels.push({ id, name }); render(); }
            };
            list.onclick = e => {
                const item = e.target.closest('.list-group-item');
                if (!item) return;
                if (e.target.classList.contains('remove-level')) {
                    currentLevels = currentLevels.filter(l => l.id != item.dataset.id);
                    render();
                }
            };
            saveBtn.onclick = () => {
                const levels = Array.from(list.children).map(el => ({
                    id: parseInt(el.dataset.id)
                }));
                fetch("{% url 'approval_control_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ levels })
                })
                .then(r => r.json())
                .then(d => {
                    alert(d.message || 'Saved!');
                    bootstrap.Modal.getInstance(controlModal).hide();
                    location.reload();
                });
            };
        }


        // CREATE DESIGNATION MODAL - IMPROVED ERROR HANDLING
const designationForm = document.getElementById('createDesignationForm');
if (designationForm) {
    designationForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('designation_name').value.trim();
        if (!name) return alert('Designation name is required');
        
        console.log('üì§ Sending designation:', name); // Debug log
        
        fetch("{% url 'designation_create_api' %}", {
            method: 'POST',
            headers: { 
                'X-CSRFToken': getCsrfToken(), 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ name: name })
        })
        .then(r => {
            console.log('üì• Response status:', r.status); // Debug log
            if (!r.ok) {
                return r.json().then(err => {
                    throw new Error(err.error || 'Server error: ' + r.status);
                });
            }
            return r.json();
        })
        .then(d => {
            console.log('‚úÖ Response data:', d); // Debug log
            if (d.id) {
                alert(`‚úÖ Designation "${name}" created successfully!`);
                bootstrap.Modal.getInstance(document.getElementById('createDesignationModal')).hide();
                designationForm.reset();
                location.reload();
            } else {
                throw new Error(d.error || 'Unknown error');
            }
        })
        .catch(err => {
            console.error('‚ùå Error creating designation:', err); // Debug log
            alert('‚ùå Error: ' + err.message);
        });
    });
}
        


// === EDIT USER (USER CONTROL PANEL) ===
const editUserModalEl = document.getElementById('editUserModal');
if (editUserModalEl) {
    const editModal = new bootstrap.Modal(editUserModalEl);
    const form = document.getElementById('editUserForm');

    // When clicking any "Edit" button in User Control table
    document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const userId = this.dataset.id;
            const username = this.dataset.username;
            const isActive = this.dataset.active === 'true';
            const signatureUrl = this.dataset.signature || '';

            // Fill the form
            document.getElementById('edit_user_id').value = userId;
            document.getElementById('edit_username').value = username;
            document.getElementById('edit_user_active').checked = isActive;

            // Show current signature preview if exists
            const preview = document.getElementById('currentSignaturePreview');
            const img = document.getElementById('currentSignatureImg');
            if (signatureUrl) {
                preview.style.display = 'block';
                img.src = signatureUrl + '?t=' + Date.now();
            } else {
                preview.style.display = 'none';
            }

            editModal.show();
        });
    });

    // Submit edit form
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('user_id', document.getElementById('edit_user_id').value);
        formData.append('username', document.getElementById('edit_username').value.trim());
        formData.append('is_active', document.getElementById('edit_user_active').checked);

        const signatureFile = document.getElementById('edit_user_signature').files[0];
        if (signatureFile) formData.append('signature', signatureFile);

        fetch("{% url 'user_update_api' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() },
            body: formData
        })
        .then(r => r.json())
        .then(d => {
            if (d.message) {
                alert('User updated successfully!');
                editModal.hide();
                location.reload();
            } else {
                alert('Error: ' + (d.error || 'Update failed'));
            }
        })
        .catch(() => alert('Network error'));
    });
}

        // === CREATE VOUCHER ===
        const voucherModal = document.getElementById('createVoucherModal');
        if (voucherModal) {
            const form = document.getElementById('createVoucherForm');
            const tbody = document.getElementById('particularsBody');
            const addBtn = document.getElementById('addParticular');
            let index = 1;
            const paymentTypeSelect = document.getElementById('payment_type');
            const chequeField = document.getElementById('chequeNumberField');
            const chequeInput = document.getElementById('cheque_number');
            const chequeAttachmentField = document.getElementById('chequeAttachmentField');
            
            const chequeDateField = document.getElementById('chequeDateField');
            const chequeDateInput = document.getElementById('cheque_date');
            const accountDetailsField = document.getElementById('accountDetailsField');
            const accountDetailsSelect = document.getElementById('account_details');
            

            voucherModal.addEventListener('show.bs.modal', loadAccounts);
            // Show/Hide Cheque Fields
function toggleChequeFields() {
    if (!paymentTypeSelect) return;

    // get the actual <select id="account_details"> element (may be inside the modal form)
    const accountDetailsSelect = document.getElementById('account_details');

    if (paymentTypeSelect.value === "CHEQUE") {
        chequeField.style.display = "block";
        chequeDateField.style.display = "block";
        accountDetailsField.style.display = "block";
        chequeAttachmentField.style.display = "block";

        // Make account_details required only when cheque selected
        if (accountDetailsSelect) accountDetailsSelect.required = true;
    } else {
        chequeField.style.display = "none";
        chequeDateField.style.display = "none";
        accountDetailsField.style.display = "none";
        chequeAttachmentField.style.display = "none";

        // Remove required so browser won't block submit when hidden
        if (accountDetailsSelect) accountDetailsSelect.required = false;
    }
}


// When user changes payment type
paymentTypeSelect?.addEventListener("change", toggleChequeFields);

// When modal opens
voucherModal?.addEventListener("shown.bs.modal", toggleChequeFields);

// Initial load
const mainAttachmentInput = document.getElementById('main_attachments');
            const chequeAttachmentInput = document.getElementById('cheque_attachments');
toggleChequeFields();

            // File name display for main & cheque
            mainAttachmentInput?.addEventListener('change', e => {
                const files = Array.from(e.target.files);
                document.getElementById('fileName').innerHTML = files.length ? files.map(f => `Selected: ${f.name}`).join('<br>') : '';
            });
            chequeAttachmentInput?.addEventListener('change', e => {
                const files = Array.from(e.target.files);
                document.getElementById('chequeFileName').innerHTML = files.length ? files.map(f => `Selected: ${f.name}`).join('<br>') : '';
            })

            
            


            tbody.onclick = e => {
                if (e.target.classList.contains('remove-row') && tbody.children.length > 1)
                    e.target.closest('tr').remove();
            };

            // File list for each particular row
            tbody.addEventListener('change', e => {
                if (e.target.name.startsWith("particular_attachment_")) {

                    const files = Array.from(e.target.files);
                    const div = e.target.closest('td').querySelector('.particular-file-list');
                    div.innerHTML = files.length ? `${files.length} file(s) selected` : '';
                }
            });

            form.onsubmit = e => {
                e.preventDefault();
                const formData = new FormData();
                const voucherDate = document.getElementById('voucher_date').value;
                const paymentType = document.getElementById('payment_type').value;
                const nameTitle = document.getElementById('name_title').value;
                const payTo = document.getElementById('pay_to').value.trim();

                if (!voucherDate || !paymentType || !nameTitle || !payTo)
                    return alert('Fill all required fields');

                formData.append('voucher_date', voucherDate);
                formData.append('payment_type', paymentType);
                formData.append('name_title', nameTitle);
                formData.append('pay_to', payTo);

                // Main attachments
                if (mainAttachmentInput?.files.length) {
                    Array.from(mainAttachmentInput.files).forEach(file => {
                        formData.append('main_attachments', file);
                    });
                }

                if (paymentType === 'CHEQUE') {
                    const cn = chequeInput.value.trim();
                    if (!cn) return alert('Cheque number required');
                    formData.append('cheque_number', cn);
                    const chequeFiles = chequeAttachmentInput?.files;
                    if (!chequeFiles || chequeFiles.length === 0) return alert('At least one cheque attachment required');
                    Array.from(chequeFiles).forEach(file => formData.append('cheque_attachments', file));
                    const chequeDate = chequeDateInput.value;
                    if (!chequeDate) return alert('Cheque date required');
                    formData.append('cheque_date', chequeDate);
                    const accVal = accountDetailsSelect.value;
                    if (!accVal) return alert('Account Details required for Cheque');
                    formData.append('account_details', accVal);
                }

                let valid = true;
                const particulars = [];
                document.querySelectorAll('#particularsBody tr').forEach((row, i) => {
                    const desc = row.querySelector('input[name*="[description]"]').value.trim();
                    const amt = row.querySelector('input[name*="[amount]"]').value.trim();
                    const fileInput = row.querySelector('input[type="file"]');
                    const files = fileInput.files;

                    if (desc && amt && files.length > 0) {
                        particulars.push({ description: desc, amount: amt });
                        Array.from(files).forEach(file => {
                            formData.append(`particular_attachment_${i}`, file);
                        });
                    } else if (desc || amt || files.length > 0) {
                        valid = false;
                    }
                });

                if (!valid || particulars.length === 0) {
                    return alert('Complete all particulars with description, amount and at least one attachment');
                }

                particulars.forEach((p, i) => {
                    formData.append(`particulars[${i}][description]`, p.description);
                    formData.append(`particulars[${i}][amount]`, p.amount);
                });

                fetch("{% url 'voucher_create_api' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken() },
                    body: formData
                })
                .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
                .then(data => {
                    // ‚úÖ FIX: Check if element exists before setting textContent
                    const successMessageEl = document.getElementById('successMessage');
                    if (successMessageEl) {
                        successMessageEl.textContent = data.message || `Voucher ${data.voucher?.voucher_number || ''} created!`;
                    }
                    
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    bootstrap.Modal.getInstance(voucherModal).hide();
                    form.reset();
                    
                    const fileNameEl = document.getElementById('fileName');
                    if (fileNameEl) fileNameEl.textContent = '';
                    
                    const chequeFileNameEl = document.getElementById('chequeFileName');
                    if (chequeFileNameEl) chequeFileNameEl.textContent = '';
                    
                    document.querySelectorAll('.particular-file-list').forEach(el => el.textContent = '');
                    tbody.innerHTML = `<tr>
                        <td><input type="text" class="form-control form-control-sm" name="particulars[0][description]" required></td>
                        <td><input type="number" step="0.01" class="form-control form-control-sm" name="particulars[0][amount]" required></td>
                        <td>
                            <input type="file" class="form-control form-control-sm"
       name="particular_attachment_0"
       multiple
       accept="image/*,application/pdf"
       required>

                            <div class="mt-1 text-muted small particular-file-list"></div>
                        </td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                    </tr>`;
                    index = 1;
                })
                .catch(err => {
                    console.error(err);
                    alert('Error: ' + (err.error || 'Failed to create voucher'));
                });
            };
        }

        // ‚úÖ FIX: Proper focus management for success modal (MOVED OUTSIDE form.onsubmit)
        document.getElementById('successOkBtn')?.addEventListener('click', function() {
            // Blur the button first
            this.blur();
            
            // Then close modal and redirect
            const modal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
            if (modal) {
                modal.hide();
            }
            
            // Wait for modal to fully close before redirecting
            setTimeout(() => {
                window.location.href = "{% url 'voucher_list' %}";
            }, 300);
        });
           
        
        // === CHANGE PASSWORD MODAL - FIXED & WORKING 100% ===
        const passwordForm = document.getElementById('changePasswordForm');
        if (passwordForm) {
            passwordForm.onsubmit = function(e) {
                e.preventDefault();

                const errorDiv = document.getElementById('passwordError');
                const successDiv = document.getElementById('passwordSuccess');
                errorDiv.classList.add('d-none');
                successDiv.classList.add('d-none');

                const formData = new FormData(this);
                formData.append('csrfmiddlewaretoken', window.csrfToken || "{{ csrf_token }}");

                fetch("{% url 'password_change' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Success! Django redirected to password_change_done
                        successDiv.textContent = 'Password changed successfully!';
                        successDiv.classList.remove('d-none');
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                            passwordForm.reset();
                        }, 1500);
                    } else {
                        // Error - parse HTML to extract Django messages
                        return response.text().then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const errorMsg = doc.querySelector('.errorlist')?.textContent.trim() ||
                                           doc.querySelector('.alert-danger')?.textContent.trim() ||
                                           'Please correct the errors below.';
                            errorDiv.textContent = errorMsg;
                            errorDiv.classList.remove('d-none');
                        });
                    }
                })
                .catch(err => {
                    console.error(err);
                    errorDiv.textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('d-none');
                });
            };
        }
        // === UPDATE MOBILE NUMBER MODAL ===
            const mobileForm = document.getElementById('updateMobileForm');
            if (mobileForm) {
                mobileForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData();
                    const newMobile = document.getElementById('new_mobile').value.trim();
                    if (!newMobile) {
                        return alert('Mobile number is required');
                    }
                    formData.append('mobile', newMobile);

                    const errorDiv = document.getElementById('mobileError');
                    const successDiv = document.getElementById('mobileSuccess');
                    errorDiv.classList.add('d-none');
                    successDiv.classList.add('d-none');

                    fetch("{% url 'user_update_api' %}", {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCsrfToken() },
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.message) {
                            successDiv.textContent = 'Mobile number updated successfully!';
                            successDiv.classList.remove('d-none');
                            setTimeout(() => {
                                bootstrap.Modal.getInstance(document.getElementById('updateMobileModal')).hide();
                                location.reload(); // Reload to reflect changes if needed
                            }, 1200);
                        } else {
                            errorDiv.textContent = data.error || 'Failed to update mobile number.';
                            errorDiv.classList.remove('d-none');
                        }
                    })
                    .catch(() => {
                        errorDiv.textContent = 'Network error. Please try again.';
                        errorDiv.classList.remove('d-none');
                    });
                });
            }
                // === UPDATE SIGNATURE MODAL ===
        const signatureForm = document.getElementById('updateSignatureForm');
        if (signatureForm) {
            signatureForm.onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const errorDiv = document.getElementById('signatureError');
                const successDiv = document.getElementById('signatureSuccess');
                errorDiv.classList.add('d-none');
                successDiv.classList.add('d-none');

                fetch("{% url 'user_update_api' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': window.csrfToken || "{{ csrf_token }}"
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.message) {
                        successDiv.textContent = 'Signature updated successfully!';
                        successDiv.classList.remove('d-none');
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('updateSignatureModal')).hide();
                            location.reload(); // Refresh to show new signature in navbar/print
                        }, 1200);
                    } else {
                        errorDiv.textContent = data.error || 'Failed to update signature.';
                        errorDiv.classList.remove('d-none');
                    }
                })
                .catch(() => {
                    errorDiv.textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('d-none');
                });
            };
        }
    });
    </script>

   
    {% block extra_js %}{% endblock %}
{% if user.is_superuser %}
<!-- =============================================
     COMPANY MANAGEMENT MODAL
     ============================================= -->
<div class="modal fade" id="companyManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
    <div>
        <h5 class="modal-title fw-semibold mb-0">
            <i class="bi bi-buildings me-2 text-primary"></i>
            Company Management
        </h5>
       
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

            <div class="modal-body">
                <!-- Add Company Button -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">All Companies</h6>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createCompanyModal">
                        <i class="bi bi-plus-circle me-1"></i>Add New Company
                    </button>
                </div>

                <!-- Loading State -->
                <div id="companyListLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading companies...</p>
                </div>

                <!-- Companies List -->
                <div id="companyListContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">Logo</th>
                                    <th>Company Name</th>
                                    <th>GST No</th>
                                    <th>Members</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th style="width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="companyListBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Error State -->
                <div id="companyListError" class="text-center py-5" style="display: none;">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <p class="text-danger mt-3" id="companyListErrorMsg"></p>
                    <button class="btn btn-outline-danger btn-sm" onclick="loadCompanies()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CREATE COMPANY MODAL -->
<div class="modal fade" id="createCompanyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="createCompanyForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Company Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required maxlength="200">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST No</label>
                            <input type="text" class="form-control" name="gst_no" maxlength="20" placeholder="22AAAAA0000A1Z5">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">PAN No</label>
                            <input type="text" class="form-control" name="pan_no" maxlength="15" placeholder="ABCDE1234F">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" placeholder="company@example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone" placeholder="+91 9876543210">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Logo (PNG/JPG, max 2MB)</label>
                            <input type="file" class="form-control" name="logo" accept="image/png,image/jpeg">
                            <div class="form-text">Recommended: Square logo, transparent background</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-1"></i>Create Company
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT COMPANY MODAL -->
<div class="modal fade" id="editCompanyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editCompanyForm" enctype="multipart/form-data">
                <input type="hidden" id="edit_company_id">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Company Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_company_name" name="name" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">GST No</label>
                            <input type="text" class="form-control" id="edit_company_gst" name="gst_no">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">PAN No</label>
                            <input type="text" class="form-control" id="edit_company_pan" name="pan_no">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_company_email" name="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_company_phone" name="phone">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="edit_company_address" name="address" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Logo</label>
                            <input type="file" class="form-control" name="logo" accept="image/png,image/jpeg">
                            <div id="edit_company_logo_preview" class="mt-2 text-center" style="display: none;">
                                <p class="small text-muted mb-1">Current Logo:</p>
                                <img id="edit_company_logo_img" src="" alt="Current Logo" style="max-height: 80px; border: 1px solid #dee2e6; border-radius: 4px; padding: 5px;">
                            </div>
                            <div class="form-text">Leave blank to keep current logo</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     USER-COMPANY MEMBERSHIP MANAGEMENT MODAL
     ============================================= -->
<div class="modal fade" id="membershipManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 92vw;">
        <div class="modal-content shadow-sm">

            <!-- Header -->
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-semibold">
                    <i class="bi bi-diagram-3 me-2 text-primary"></i>
                    User‚ÄìCompany Assignments
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- Loading -->
                <div id="membershipListLoading" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3"></div>
                    <div class="fw-semibold">Loading assignments</div>
                    <small class="text-muted">Please wait‚Ä¶</small>
                </div>

                <!-- Content -->
                <div id="membershipListContent" style="display: none;">

                    <!-- User Cards -->
                    <div class="row g-3" id="membershipListBody">
                        <!-- JS will inject user cards here -->
                    </div>

                </div>

                <!-- Error -->
                <div id="membershipListError" class="text-center py-5" style="display: none;">
                    <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                    <p class="text-danger mt-2" id="membershipListErrorMsg"></p>
                    <button class="btn btn-outline-danger btn-sm" onclick="loadMemberships()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry
                    </button>
                </div>

            </div>

            <div class="modal-footer bg-light">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Close
                </button>
            </div>

        </div>
    </div>
</div>


<!-- ADD MEMBERSHIP MODAL -->
<div class="modal fade" id="addMembershipModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-sm">
            
            <!-- Header -->
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="bi bi-building me-2 text-primary"></i>
                    Assign User to Company
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="addMembershipForm">
                <input type="hidden" id="add_membership_user_id">

                <div class="modal-body">

                    <!-- User Info -->
                    <div class="card border-0 bg-light mb-4">
                        <div class="card-body py-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle fs-3 text-secondary me-3"></i>
                                <div>
                                    <div class="fw-semibold" id="add_membership_username"></div>
                                    <small class="text-muted">Selected user</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Company & Group -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                Company <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="add_membership_company" required>
                                <option value="">Select company</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                Group <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="add_membership_group" required>
                                <option value="">Select group</option>
                                <option value="Accountants">Accountants</option>
                                <option value="Admin Staff">Admin Staff</option>
                            </select>
                        </div>
                    </div>

                    <!-- Designation -->
                    <div class="mb-3" id="add_membership_designation_field" style="display: none;">
                        <label class="form-label fw-semibold">
                            Designation <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="add_membership_designation">
                            <option value="">Select designation</option>
                            {% for des in designations %}
                            <option value="{{ des.id }}">{{ des.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Contact -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            Mobile Number
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-phone"></i>
                            </span>
                            <input type="text"
                                   class="form-control"
                                   id="add_membership_mobile"
                                   maxlength="15"
                                   placeholder="Optional">
                        </div>
                    </div>

                </div>

                <!-- Footer -->
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-check-circle me-1"></i>
                        Assign User
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- EDIT MEMBERSHIP MODAL -->
<div class="modal fade" id="editMembershipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editMembershipForm">
                <input type="hidden" id="edit_membership_id">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Membership</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                <div class="modal-body">
                    <p class="text-muted small">
                        User: <strong id="edit_membership_username"></strong><br>
                        Company: <strong id="edit_membership_company"></strong>
                    </p>
                    
                    <div class="mb-3">
                        <label class="form-label">Group <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_membership_group" required>
                            <option value="Accountants">Accountants</option>
                            <option value="Admin Staff">Admin Staff</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="edit_membership_designation_field" style="display: none;">
                        <label class="form-label">Designation <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_membership_designation">
                            <option value="">-- Select Designation --</option>
                            {% for des in designations %}
                            <option value="{{ des.id }}">{{ des.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" class="form-control" id="edit_membership_mobile" maxlength="15">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// =============================================
// COMPANY MANAGEMENT JAVASCRIPT
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    const companyModal = document.getElementById('companyManagementModal');
    if (companyModal) {
        companyModal.addEventListener('show.bs.modal', loadCompanies);
    }

    // Create Company Form
    const createForm = document.getElementById('createCompanyForm');
    if (createForm) {
        createForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

            fetch('/api/companies/create/', {
                method: 'POST',
                headers: { 'X-CSRFToken': window.csrfToken },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('createCompanyModal')).hide();
                    createForm.reset();
                    loadCompanies();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Network error occurred');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            });
        });
    }

    // Edit Company Form
    const editForm = document.getElementById('editCompanyForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const companyId = document.getElementById('edit_company_id').value;
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            fetch(`/api/companies/${companyId}/update/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': window.csrfToken },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('editCompanyModal')).hide();
                    loadCompanies();
                    if (data.company && data.company.logo) {
                        location.reload();
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Network error occurred');
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        });
    }

    // Membership Management
    const membershipModal = document.getElementById('membershipManagementModal');
    if (membershipModal) {
        membershipModal.addEventListener('show.bs.modal', loadMemberships);
    }

    // Add Membership Form
    const addForm = document.getElementById('addMembershipForm');
    if (addForm) {
        const groupSelect = document.getElementById('add_membership_group');
        const designationField = document.getElementById('add_membership_designation_field');
        const designationSelect = document.getElementById('add_membership_designation');

        groupSelect.addEventListener('change', function() {
            if (this.value === 'Admin Staff') {
                designationField.style.display = 'block';
                designationSelect.required = true;
            } else {
                designationField.style.display = 'none';
                designationSelect.required = false;
                designationSelect.value = '';
            }
        });

        addForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('add_membership_user_id').value;
            const companyId = document.getElementById('add_membership_company').value;
            const group = document.getElementById('add_membership_group').value;
            const designationId = document.getElementById('add_membership_designation').value;
            const mobile = document.getElementById('add_membership_mobile').value;

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            fetch('/api/memberships/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': window.csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    company_id: companyId,
                    group: group,
                    designation_id: designationId || null,
                    mobile: mobile
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('addMembershipModal')).hide();
                    addForm.reset();
                    designationField.style.display = 'none';
                    loadMemberships();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => alert('Network error: ' + err))
            .finally(() => {
                submitBtn.disabled = false;
            });
        });
    }

    // Edit Membership Form
    const editMembershipForm = document.getElementById('editMembershipForm');
    if (editMembershipForm) {
        const groupSelect = document.getElementById('edit_membership_group');
        const designationField = document.getElementById('edit_membership_designation_field');
        const designationSelect = document.getElementById('edit_membership_designation');

        groupSelect.addEventListener('change', function() {
            if (this.value === 'Admin Staff') {
                designationField.style.display = 'block';
                designationSelect.required = true;
            } else {
                designationField.style.display = 'none';
                designationSelect.required = false;
                designationSelect.value = '';
            }
        });

        editMembershipForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const membershipId = document.getElementById('edit_membership_id').value;
            const group = document.getElementById('edit_membership_group').value;
            const designationId = document.getElementById('edit_membership_designation').value;
            const mobile = document.getElementById('edit_membership_mobile').value;

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            fetch(`/api/memberships/${membershipId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': window.csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group: group,
                    designation_id: designationId || null,
                    mobile: mobile
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('editMembershipModal')).hide();
                    loadMemberships();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => alert('Network error: ' + err))
            .finally(() => {
                submitBtn.disabled = false;
            });
        });
    }
});

function loadCompanies() {
    const loading = document.getElementById('companyListLoading');
    const content = document.getElementById('companyListContent');
    const error = document.getElementById('companyListError');
    const tbody = document.getElementById('companyListBody');

    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';

    fetch('/api/companies/')
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(data => {
            tbody.innerHTML = '';

            if (!data.companies || data.companies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No companies found. Click "Add New Company" to create one.</td></tr>';
            } else {
                data.companies.forEach(company => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center">
                            ${company.logo ? 
                                `<img src="${company.logo}" alt="${escapeHtml(company.name)}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 4px;">` :
                                `<div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-building text-white"></i>
                                </div>`
                            }
                        </td>
                        <td><strong>${escapeHtml(company.name)}</strong></td>
                        <td><small class="text-muted">${company.gst_no || '‚Äî'}</small></td>
                        <td><span class="badge bg-info">${company.member_count}</span></td>
                        <td><small class="text-muted">${company.voucher_count}V / ${company.function_count}F</small></td>
                        <td>
                            <span class="badge bg-${company.is_active ? 'success' : 'secondary'}">
                                ${company.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td><small class="text-muted">${company.created_at}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCompany(${company.id})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-${company.is_active ? 'warning' : 'success'}" 
                                        onclick="toggleCompany(${company.id})" 
                                        title="${company.is_active ? 'Deactivate' : 'Activate'}">
                                    <i class="bi bi-${company.is_active ? 'pause' : 'play'}-circle"></i>
                                </button>
                                ${company.voucher_count === 0 && company.function_count === 0 ? 
                                    `<button class="btn btn-outline-danger" 
                                             onclick="deleteCompany(${company.id}, '${escapeHtml(company.name)}')" 
                                             title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>` : ''
                                }
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            loading.style.display = 'none';
            content.style.display = 'block';
        })
        .catch(err => {
            console.error('Error loading companies:', err);
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('companyListErrorMsg').textContent = 'Failed to load companies: ' + err.message;
        });
}

function editCompany(id) {
    fetch('/api/companies/')
        .then(r => r.json())
        .then(data => {
            const company = data.companies.find(c => c.id === id);
            if (!company) return alert('Company not found');

            document.getElementById('edit_company_id').value = company.id;
            document.getElementById('edit_company_name').value = company.name;
            document.getElementById('edit_company_gst').value = company.gst_no;
            document.getElementById('edit_company_pan').value = company.pan_no;
            document.getElementById('edit_company_email').value = company.email;
            document.getElementById('edit_company_phone').value = company.phone;
            document.getElementById('edit_company_address').value = company.address;

            const logoPreview = document.getElementById('edit_company_logo_preview');
            const logoImg = document.getElementById('edit_company_logo_img');
            if (company.logo) {
                logoImg.src = company.logo + '?t=' + Date.now();
                logoPreview.style.display = 'block';
            } else {
                logoPreview.style.display = 'none';
            }

            new bootstrap.Modal(document.getElementById('editCompanyModal')).show();
        });
}

function toggleCompany(id) {
    if (!confirm('Toggle company active status?')) return;

    fetch(`/api/companies/${id}/toggle/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': window.csrfToken, 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadCompanies();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => alert('Network error: ' + err));
}

function deleteCompany(id, name) {
    if (!confirm(`Permanently delete company "${name}"?\n\nThis action cannot be undone.`)) return;

    fetch(`/api/companies/${id}/delete/`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': window.csrfToken }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadCompanies();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => alert('Network error: ' + err));
}

function loadMemberships() {
    const loading = document.getElementById('membershipListLoading');
    const content = document.getElementById('membershipListContent');
    const error = document.getElementById('membershipListError');
    const tbody = document.getElementById('membershipListBody');

    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';
fetch('/api/memberships/')
    .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    })
    .then(data => {
        tbody.innerHTML = '';

        if (!data.users || data.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">No users found</td></tr>';
        } else {
            window.availableCompanies = data.companies;

            data.users.forEach(user => {
                const row = document.createElement('tr');
                
                let membershipsHTML = '';
                if (user.memberships.length === 0) {
                    membershipsHTML = '<span class="text-muted small">No company assignments</span>';
                } else {
                    membershipsHTML = '<div class="d-flex flex-wrap gap-2">';
                    user.memberships.forEach(m => {
                       membershipsHTML += `
                        <div class="border rounded p-2 ${!m.is_active ? 'bg-light opacity-75' : ''}" style="min-width: 250px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="d-block">${escapeHtml(m.company_name)}</strong>
                                    ${!m.is_active ? '<span class="badge bg-secondary me-1">Inactive</span>' : ''}
                                    <span class="badge bg-primary">${m.group}</span>
                                        ${m.designation_name ? `<span class="badge bg-secondary">${escapeHtml(m.designation_name)}</span>` : ''}
                                        ${m.mobile ? `<br><small class="text-muted"><i class="bi bi-phone"></i> ${escapeHtml(m.mobile)}</small>` : ''}
                                    </div>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="editMembership(${m.id}, '${escapeHtml(user.username)}', '${escapeHtml(m.company_name)}', '${m.group}', ${m.designation_id || 'null'}, '${escapeHtml(m.mobile || '')}')" 
                                                title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-${m.is_active ? 'warning' : 'success'} btn-sm" 
                                                onclick="toggleMembership(${m.id}, '${escapeHtml(user.username)}', '${escapeHtml(m.company_name)}', ${m.is_active})" 
                                                title="${m.is_active ? 'Disable' : 'Enable'} Access">
                                            <i class="bi bi-${m.is_active ? 'pause' : 'play'}-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    membershipsHTML += '</div>';
                }

                row.innerHTML = `
                    <div class="border rounded p-3 bg-light">

                        <!-- USER HEADER -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-person-circle fs-4 text-secondary"></i>
                                <div>
                                    <div class="fw-semibold">
                                        ${escapeHtml(user.username)}
                                        ${user.is_superuser ? '<span class="badge bg-danger ms-1">Superuser</span>' : ''}
                                    </div>
                                    <small class="text-muted">Company Assinged</small>
                                </div>
                            </div>

                            <button class="btn btn-outline-primary btn-sm"
                                    onclick="showAddMembership(${user.id}, '${escapeHtml(user.username)}')">
                                <i class="bi bi-plus-lg me-1"></i>Assign
                            </button>
                        </div>

                        <!-- COMPANIES -->
                        <div class="d-flex flex-wrap gap-2 ps-4">
                            ${membershipsHTML}
                        </div>

                    </div>
                    `;
                tbody.appendChild(row);
            });
        }

        loading.style.display = 'none';
        content.style.display = 'block';
    })
    .catch(err => {
        console.error('Error loading memberships:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
        document.getElementById('membershipListErrorMsg').textContent = 'Failed to load memberships: ' + err.message;
    });
    }
function showAddMembership(userId, username) {
    document.getElementById('add_membership_user_id').value = userId;
    document.getElementById('add_membership_username').textContent = username;
    
    // ‚úÖ ONLY ONCE - populate company dropdown
    const companySelect = document.getElementById('add_membership_company');
    companySelect.innerHTML = '<option value="">-- Select Company --</option>';

    if (window.availableCompanies) {
        window.availableCompanies.forEach(company => {
            const option = document.createElement('option');
            option.value = company.id;
            option.textContent = company.name;
            companySelect.appendChild(option);
        });
    }

    document.getElementById('addMembershipForm').reset();
    document.getElementById('add_membership_user_id').value = userId; // Re-set after reset
    document.getElementById('add_membership_username').textContent = username;
    document.getElementById('add_membership_designation_field').style.display = 'none';

    new bootstrap.Modal(document.getElementById('addMembershipModal')).show();
}

function editMembership(id, username, companyName, group, designationId, mobile) {
    document.getElementById('edit_membership_id').value = id;
    document.getElementById('edit_membership_username').textContent = username;
    document.getElementById('edit_membership_company').textContent = companyName;
    document.getElementById('edit_membership_group').value = group;
    document.getElementById('edit_membership_mobile').value = mobile || '';
    
    const designationField = document.getElementById('edit_membership_designation_field');
    const designationSelect = document.getElementById('edit_membership_designation');

    if (group === 'Admin Staff') {
        designationField.style.display = 'block';
        designationSelect.required = true;
        designationSelect.value = designationId || '';
    } else {
        designationField.style.display = 'none';
        designationSelect.required = false;
    }

    new bootstrap.Modal(document.getElementById('editMembershipModal')).show();
}

function toggleMembership(id, username, companyName, isActive) {
    const action = isActive ? 'disable' : 'enable';
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} ${username}'s access to ${companyName}?`)) return;
    
    fetch(`/api/memberships/${id}/toggle/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': window.csrfToken }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadMemberships();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => alert('Network error: ' + err));
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
<script>
// ============================================
// FORCE RELOAD ON COMPANY SWITCH
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // Store current company ID in sessionStorage to detect changes
    const currentCompanyId = '{{ active_company.id|default:"" }}';
    const storedCompanyId = sessionStorage.getItem('last_company_id');
    
    // If company changed, clear any cached data
    if (storedCompanyId && storedCompanyId !== currentCompanyId) {
        console.log('‚úÖ Company switched - clearing cached data');
        // You could clear specific cached data here if needed
    }
    
    // Update stored company ID
    if (currentCompanyId) {
        sessionStorage.setItem('last_company_id', currentCompanyId);
    }
});

// ============================================
// RELOAD MODALS WHEN OPENED
// ============================================

// Control Approval Modal - Reload data when opened
const approvalControlModal = document.getElementById('approvalControlModal');
if (approvalControlModal) {
    approvalControlModal.addEventListener('show.bs.modal', function() {
        console.log('üîÑ Reloading approval levels for current company...');
        loadApprovalLevels(); // This function should already exist in your base.html
    });
}

// User Rights Modal - Reload data when opened
const userRightsModal = document.getElementById('userRightsModal');
if (userRightsModal) {
    userRightsModal.addEventListener('show.bs.modal', function() {
        console.log('üîÑ Reloading user rights for current company...');
        loadUserRights(); // This function should already exist in your base.html
    });
}

// ============================================
// HELPER: Load Approval Levels from API
// ============================================
function loadApprovalLevels() {
    fetch('/api/approval/control/', {
        headers: {
            'X-CSRFToken': window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        }
    })
    .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    })
    .then(data => {
        console.log('‚úÖ Approval levels loaded:', data);
        // Update the modal UI with new data
        renderApprovalLevels(data);
    })
    .catch(err => {
        console.error('‚ùå Error loading approval levels:', err);
        alert('Failed to load approval levels: ' + err.message);
    });
}

function renderApprovalLevels(data) {
    const list = document.getElementById('approvalLevelsList');
    const select = document.getElementById('addDesignationSelect');
    
    if (!list || !select) return;
    
    const allDesignations = data.all_designations || [];
    const currentLevels = data.levels || [];
    
    // Clear and rebuild list
    list.innerHTML = '';
    currentLevels.forEach((lvl, idx) => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.draggable = true;
        item.dataset.id = lvl.id;
        item.innerHTML = `
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-grip-vertical grip-handle"></i>
                <strong>${idx + 1}.</strong>
                <span>${lvl.name}</span>
            </div>
            <div>
                <button class="btn btn-sm btn-danger ms-2 remove-level">Remove</button>
            </div>
        `;
        list.appendChild(item);
    });
    
    // Update dropdown
    const usedIds = currentLevels.map(l => l.id);
    select.innerHTML = '<option value="">-- Add Designation --</option>';
    allDesignations.forEach(d => {
        if (!usedIds.includes(d.id)) {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.name;
            select.appendChild(opt);
        }
    });
}
</script>
{% endif %}

</body>
</html>