{% extends 'base.html' %}
{% load static %}

{% block title %}{{ function.function_name }} - Function Details{% endblock %}
{% block content %}
<div class="container py-5">
    <!-- Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0">
                <i class="bi bi-calendar-event me-2"></i>Function Details
            </h2>
            <p class="text-muted mb-0">{{ function.function_number }}</p>
        </div>
        <div>
            <a href="{% url 'function' %}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left me-2"></i>Back to Calendar
            </a>
            {% if is_admin_staff or user.is_superuser %}
            <button class="btn btn-warning me-2" onclick="showEditModal()">
                <i class="bi bi-pencil me-2"></i>Edit
            </button>
            <button class="btn btn-danger" onclick="deleteFunction()">
                <i class="bi bi-trash me-2"></i>Delete
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Status Badge -->
    <div class="mb-4">
        {% if function.status == 'CONFIRMED' %}
            <span class="badge bg-success fs-6 px-4 py-2">
                <i class="bi bi-check-circle me-2"></i>Function Confirmed
            </span>
        {% elif function.status == 'CANCELLED' %}
            <span class="badge bg-danger fs-6 px-4 py-2">
                <i class="bi bi-x-circle me-2"></i>Cancelled
            </span>
        {% else %}
            <span class="badge bg-warning text-dark fs-6 px-4 py-2">
                <i class="bi bi-clock-history me-2"></i>Pending Confirmation
            </span>
        {% endif %}
    </div>

    <!-- Function Information Card -->
    <div class="card border-0 shadow-lg">
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0 fw-bold">
                <i class="bi bi-info-circle me-2"></i>{{ function.function_name }}
            </h4>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                <!-- Left Column -->
                <div class="col-md-6">
                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">Location</label>
                        <p class="fs-5 fw-bold text-primary mb-0">{{ function.location }}</p>
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">FUNCTION NAME</label>
                        <p class="fs-5 mb-0">{{ function.function_name }}</p>
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">BOOKED BY</label>
                        <p class="fs-5 mb-0">{{ function.booked_by }}</p>
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">CONTACT NUMBERS</label>
                        {% for number in function.contact_numbers %}
                        <p class="fs-5 mb-1">
                            <i class="bi bi-telephone text-primary me-2"></i>{{ number }}
                        </p>
                        {% endfor %}
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">ADDRESS</label>
                        <p class="fs-5 mb-0" style="white-space: pre-line;">{{ function.address }}</p>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-md-6">
                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">FUNCTION DATE</label>
                        <p class="fs-5 mb-0">
                            <i class="bi bi-calendar3 text-warning me-2"></i>{{ function.function_date|date:"d M Y" }}
                        </p>
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">TIME</label>
                        <p class="fs-5 mb-0">
                            <i class="bi bi-clock text-info me-2"></i>{{ function.time_from|time:"H:i" }} - {{ function.time_to|time:"H:i" }}
                        </p>
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">CREATED BY</label>
                        <p class="fs-5 mb-0">{{ function.created_by.username }}</p>
                    </div>

                    <div class="mb-4">
                        <label class="text-muted small fw-semibold mb-1">CREATED AT</label>
                        <p class="fs-5 mb-0">{{ function.created_at|date:"d M Y, H:i" }}</p>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <!-- Menu Items -->
            {% if function.menu_items %}
            <div class="mb-4">
                <label class="text-muted small fw-semibold mb-2">MENU ITEMS</label>
                <ul class="list-group">
                    {% for item in function.menu_items %}
                    <li class="list-group-item">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            <hr class="my-4">
            {% endif %}

            <!-- Pricing Details -->
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">NUMBER OF PAX</label>
                            <p class="fs-4 fw-bold text-success mb-0">
                                <i class="bi bi-people me-2"></i>{{ function.no_of_pax }}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">RATE PER PAX</label>
                            <p class="fs-4 fw-bold text-info mb-0">₹{{ function.rate_per_pax }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">GST</label>
                            <p class="fs-5 fw-bold mb-0">
                                {% if function.gst_option == 'INCLUDING' %}
                                <span class="badge bg-success">Including GST (5%)</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Excluding GST</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hall Rent & Extra Charges -->
            {% if function.hall_rent or function.extra_charges %}
            <hr class="my-4">
            <div class="row g-4">
                {% if function.hall_rent %}
                <div class="col-md-6">
                    <div class="card bg-warning bg-opacity-10 border-warning">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">HALL RENT</label>
                            <p class="fs-4 fw-bold text-warning mb-0">₹{{ function.hall_rent }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if function.extra_charges %}
                <div class="col-md-6">
                    <label class="text-muted small fw-semibold mb-2">EXTRA CHARGES</label>
                    {% for charge in function.extra_charges %}
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ charge.description }}</span>
                                <strong>₹{{ charge.rate }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Total Amount -->
            <hr class="my-4">
            <div class="alert alert-success text-center">
                <h3 class="mb-0">
                    <strong>TOTAL AMOUNT: ₹{{ function.total_amount|floatformat:2 }}</strong>
                </h3>
            </div>

            <!-- Confirmation Details (if confirmed) -->
            {% if function.status == 'CONFIRMED' %}
            <hr class="my-4">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card bg-success bg-opacity-10 border-success">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">ADVANCE AMOUNT PAID</label>
                            <p class="fs-4 fw-bold text-success mb-0">₹{{ function.advance_amount|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info bg-opacity-10 border-info">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">CONFIRMED BY</label>
                            <p class="fs-5 fw-bold text-info mb-0">{{ function.confirmed_by.username }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success bg-opacity-10 border-success">
                        <div class="card-body">
                            <label class="text-muted small fw-semibold mb-1">DUE AMOUNT</label>
                            <p class="fs-4 fw-bold text-success mb-0">₹{{ function.due_amount }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Confirm Function Button (only for pending functions) -->
    {% if function.status == 'PENDING' and is_admin_staff or user.is_superuser %}
    <div class="text-center mt-4">
        <button class="btn btn-success btn-lg px-5 py-3" onclick="showConfirmModal()">
            <i class="bi bi-check-circle me-2"></i>Confirm Function
        </button>
    </div>
    {% endif %}

    <!-- Event Status Badge -->
    <div class="text-center mt-4">
        {% now "Y-m-d" as today %}
        {% if function.function_date|date:"Y-m-d" < today %}
            <span class="badge bg-secondary fs-6 px-4 py-2">
                <i class="bi bi-check-circle me-2"></i>Event Completed
            </span>
        {% elif function.function_date|date:"Y-m-d" == today %}
            <span class="badge bg-warning text-dark fs-6 px-4 py-2">
                <i class="bi bi-clock-history me-2"></i>Event Today
            </span>
        {% else %}
            <span class="badge bg-info fs-6 px-4 py-2">
                <i class="bi bi-calendar-check me-2"></i>Upcoming Event
            </span>
        {% endif %}
    </div>
</div>

<!-- EDIT FUNCTION MODAL (Similar to Create Modal) -->
<div class="modal fade" id="editFunctionModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-pencil me-2"></i>Edit Function
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editFunctionForm">
                <div class="modal-body p-4" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Same structure as create modal but with pre-filled values -->
                    <div class="row g-3">
                        <!-- Date -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Function Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="edit_function_date" required>
                        </div>

                        <!-- Time From -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Time From <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="edit_time_from" required>
                        </div>

                        <!-- Time To -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Time To <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="edit_time_to" required>
                        </div>

                        <!-- Function Name -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Function Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_function_name" required maxlength="200">
                        </div>

                        <!-- Booked By -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Booked By <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_booked_by" required maxlength="200">
                        </div>

                        <!-- Contact Numbers -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Contact Numbers <span class="text-danger">*</span></label>
                            <div id="editContactNumbersContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditContactNumber()">
                                <i class="bi bi-plus-circle me-1"></i>Add Another Number
                            </button>
                        </div>

                        <!-- Address -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Address <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="edit_address" rows="3" required maxlength="500"></textarea>
                        </div>

                        <!-- Menu Items -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Menu Items</label>
                            <textarea class="form-control" id="edit_menu_items" rows="4"></textarea>
                        </div>

                        <!-- Number of Pax -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Number of Pax <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="edit_no_of_pax" required min="1" onchange="calculateEditTotal()">
                        </div>

                        <!-- Rate Per Pax -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Rate Per Pax <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="edit_rate_per_pax" required min="0" step="0.01" onchange="calculateEditTotal()">
                        </div>

                        <!-- GST Options -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">GST <span class="text-danger">*</span></label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="edit_gst_option" 
                                           id="edit_gst_including" value="INCLUDING" onchange="calculateEditTotal()">
                                    <label class="form-check-label" for="edit_gst_including">Including GST (5%)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="edit_gst_option" 
                                           id="edit_gst_excluding" value="EXCLUDING" onchange="calculateEditTotal()">
                                    <label class="form-check-label" for="edit_gst_excluding">Excluding GST</label>
                                </div>
                            </div>
                        </div>

                        <!-- Hall Rent -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Hall Rent (Optional)</label>
                            <input type="number" class="form-control" id="edit_hall_rent" min="0" step="0.01" value="0" onchange="calculateEditTotal()">
                        </div>

                        <!-- Extra Charges -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Extra Charges (Optional)</label>
                            <div id="editExtraChargesContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditExtraCharge()">
                                <i class="bi bi-plus-circle me-1"></i>Add Extra Charge
                            </button>
                        </div>

                        <!-- Total Amount Display -->
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h5 class="mb-0"><strong>Total Amount: ₹<span id="editTotalAmountDisplay">0.00</span></strong></h5>
                            </div>
                        </div>
                    </div>

                    <div id="editFormError" class="alert alert-danger mt-3 d-none"></div>
                    <div id="editFormSuccess" class="alert alert-success mt-3 d-none"></div>
                </div>

                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning px-5">
                        <i class="bi bi-check-lg me-2"></i>Update Function
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ENHANCED CONFIRMATION MODAL -->
<div class="modal fade" id="confirmFunctionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-check-circle me-2"></i>Confirm Function
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="confirmFunctionForm">
                <div class="modal-body p-4">
                    <!-- Total Amount Display -->
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><strong>Total Amount:</strong></span>
                            <span class="fs-5 fw-bold">₹<span id="confirm_total_amount">{{ function.total_amount|floatformat:2 }}</span></span>
                        </div>
                    </div>
                    
                    <!-- Location Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            Location <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="location" required>
                            <option value="">Select Location</option>
                            <option value="Banquet">Banquet</option>
                            <option value="Restaurant">Restaurant</option>
                            <option value="Family Room">Family Room</option>
                            <option value="Outdoor">Outdoor</option>
                        </select>
                        <small class="text-muted">Select where the function will be held</small>
                    </div>
                    
                    <!-- Advance Amount -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            Advance Amount Received <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="advance_amount" 
                               min="0" step="0.01" required 
                               placeholder="Enter advance amount received"
                               oninput="calculateDueAmount()">
                        <small class="text-muted">Enter the advance payment amount received from the customer</small>
                    </div>

                    <!-- Due Amount Display (Auto-calculated) -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Due Amount</label>
                        <div class="alert alert-warning mb-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>Remaining Amount:</strong></span>
                                <span class="fs-5 fw-bold text-danger">₹<span id="due_amount">{{ function.total_amount|floatformat:2 }}</span></span>
                            </div>
                        </div>
                        <small class="text-muted">This is the amount remaining to be paid</small>
                    </div>

                    <div id="confirmFormError" class="alert alert-danger mt-3 d-none"></div>
                    <div id="confirmFormSuccess" class="alert alert-success mt-3 d-none"></div>
                </div>

                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success px-4">
                        <i class="bi bi-check-circle me-2"></i>Confirm Function
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Keep your existing confirmation modal code here -->

<script>
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
}


// Calculate Due Amount automatically
function calculateDueAmount() {
    const totalAmount = parseFloat(document.getElementById('confirm_total_amount').textContent) || 0;
    const advanceAmount = parseFloat(document.getElementById('advance_amount').value) || 0;
    const dueAmount = totalAmount - advanceAmount;
    
    // Update due amount display
    document.getElementById('due_amount').textContent = dueAmount.toFixed(2);
    
    // Show warning if advance exceeds total
    const errorDiv = document.getElementById('confirmFormError');
    if (advanceAmount > totalAmount) {
        errorDiv.textContent = 'Advance amount cannot exceed total amount';
        errorDiv.classList.remove('d-none');
    } else {
        errorDiv.classList.add('d-none');
    }
}

// Show Confirmation Modal
function showConfirmModal() {
    const modal = new bootstrap.Modal(document.getElementById('confirmFunctionModal'));
    
    // Reset form
    document.getElementById('advance_amount').value = '';
    document.getElementById('location').value = '';
    document.getElementById('due_amount').textContent = document.getElementById('confirm_total_amount').textContent;
    document.getElementById('confirmFormError').classList.add('d-none');
    document.getElementById('confirmFormSuccess').classList.add('d-none');
    
    modal.show();
}

// Confirm Function Form Submission
document.getElementById('confirmFunctionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const errorDiv = document.getElementById('confirmFormError');
    const successDiv = document.getElementById('confirmFormSuccess');
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    const advanceAmount = document.getElementById('advance_amount').value;
    const location = document.getElementById('location').value;
    const totalAmount = parseFloat(document.getElementById('confirm_total_amount').textContent);
    
    // Validation
    if (!advanceAmount || parseFloat(advanceAmount) < 0) {
        errorDiv.textContent = 'Please enter a valid advance amount';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    if (parseFloat(advanceAmount) > totalAmount) {
        errorDiv.textContent = 'Advance amount cannot exceed total amount';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    if (!location) {
        errorDiv.textContent = 'Please select a location';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirming...';
    
    const dueAmount = totalAmount - parseFloat(advanceAmount);
    
    fetch(`/api/functions/{{ function.id }}/confirm/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            advance_amount: advanceAmount,
            due_amount: dueAmount.toFixed(2),
            location: location
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            successDiv.textContent = data.message;
            successDiv.classList.remove('d-none');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            errorDiv.textContent = data.error || 'Failed to confirm function';
            errorDiv.classList.remove('d-none');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirm Function';
        }
    })
    .catch(err => {
        console.error(err);
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirm Function';
    });
});

// Delete Function
function deleteFunction() {
    if (!confirm('Are you sure you want to delete this function? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/functions/{{ function.id }}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '{% url "function" %}';
        } else {
            alert(data.error || 'Failed to delete function');
        }
    })
    .catch(err => {
        console.error(err);
        alert('Network error. Please try again.');
    });
}

// Edit Modal Functions
function showEditModal() {
    const modal = new bootstrap.Modal(document.getElementById('editFunctionModal'));
    
    // Pre-fill data
    document.getElementById('edit_function_date').value = '{{ function.function_date|date:"Y-m-d" }}';
    document.getElementById('edit_time_from').value = '{{ function.time_from|time:"H:i" }}';
    document.getElementById('edit_time_to').value = '{{ function.time_to|time:"H:i" }}';
    document.getElementById('edit_function_name').value = '{{ function.function_name }}';
    document.getElementById('edit_booked_by').value = '{{ function.booked_by }}';
    document.getElementById('edit_address').value = `{{ function.address }}`;
    
    // Menu items
    const menuItems = {{ function.menu_items|safe }};
    document.getElementById('edit_menu_items').value = menuItems.join('\n');
    
    // Contact numbers
    const contactNumbers = {{ function.contact_numbers|safe }};
    const container = document.getElementById('editContactNumbersContainer');
    container.innerHTML = '';
    contactNumbers.forEach((number, index) => {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <input type="tel" class="form-control edit-contact-number" 
                   value="${number}" pattern="[0-9]{10}" maxlength="10">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditContactNumber(this)" 
                    style="display:${contactNumbers.length > 1 ? 'block' : 'none'}">
                <i class="bi bi-trash"></i>
            </button>
        `;
        container.appendChild(div);
    });
    
    // Pricing
    document.getElementById('edit_no_of_pax').value = '{{ function.no_of_pax }}';
    document.getElementById('edit_rate_per_pax').value = '{{ function.rate_per_pax }}';
    document.getElementById('edit_hall_rent').value = '{{ function.hall_rent|default:0 }}';
    
    // GST
    if ('{{ function.gst_option }}' === 'INCLUDING') {
        document.getElementById('edit_gst_including').checked = true;
    } else {
        document.getElementById('edit_gst_excluding').checked = true;
    }
    
    // Extra charges
    const extraCharges = {{ function.extra_charges|safe }};
    const extraContainer = document.getElementById('editExtraChargesContainer');
    extraContainer.innerHTML = '';
    extraCharges.forEach(charge => {
        addEditExtraCharge(charge.description, charge.rate);
    });
    
    calculateEditTotal();
    modal.show();
}

function addEditContactNumber() {
    const container = document.getElementById('editContactNumbersContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="tel" class="form-control edit-contact-number" 
               placeholder="e.g., 9876543210" pattern="[0-9]{10}" maxlength="10">
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditContactNumber(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(div);
    updateEditContactNumberButtons();
}

function removeEditContactNumber(btn) {
    btn.closest('.input-group').remove();
    updateEditContactNumberButtons();
}

function updateEditContactNumberButtons() {
    const buttons = document.querySelectorAll('#editContactNumbersContainer .btn-outline-danger');
    buttons.forEach(btn => {
        btn.style.display = buttons.length > 1 ? 'block' : 'none';
    });
}

function addEditExtraCharge(desc = '', rate = '') {
    const container = document.getElementById('editExtraChargesContainer');
    const div = document.createElement('div');
    div.className = 'row g-2 mb-2 edit-extra-charge-row';
    div.innerHTML = `
        <div class="col-md-7">
            <input type="text" class="form-control edit-extra-charge-desc" 
                   placeholder="Description" value="${desc}" required>
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control edit-extra-charge-rate" 
                   placeholder="Rate" value="${rate}" min="0" step="0.01" required onchange="calculateEditTotal()">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeEditExtraCharge(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
}

function removeEditExtraCharge(btn) {
    btn.closest('.edit-extra-charge-row').remove();
    calculateEditTotal();
}

function calculateEditTotal() {
    const pax = parseFloat(document.getElementById('edit_no_of_pax')?.value || 0);
    const rate = parseFloat(document.getElementById('edit_rate_per_pax')?.value || 0);
    const gstOption = document.querySelector('input[name="edit_gst_option"]:checked')?.value;
    const hallRent = parseFloat(document.getElementById('edit_hall_rent')?.value || 0);
    
    let baseAmount = pax * rate;
    if (gstOption === 'INCLUDING') {
        baseAmount = baseAmount * 1.05;
    }
    
    let total = baseAmount + hallRent;
    
    const extraCharges = document.querySelectorAll('.edit-extra-charge-rate');
    extraCharges.forEach(input => {
        total += parseFloat(input.value || 0);
    });
    
    document.getElementById('editTotalAmountDisplay').textContent = total.toFixed(2);
}

// Edit Form Submission
document.getElementById('editFunctionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const errorDiv = document.getElementById('editFormError');
    const successDiv = document.getElementById('editFormSuccess');
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    // Collect data
    const contactNumbers = [];
    document.querySelectorAll('.edit-contact-number').forEach(input => {
        if (input.value.trim()) contactNumbers.push(input.value.trim());
    });
    
    const menuText = document.getElementById('edit_menu_items').value;
    const menuItems = menuText.split('\n').filter(item => item.trim()).map(item => item.trim());
    
    const extraCharges = [];
    document.querySelectorAll('.edit-extra-charge-row').forEach(row => {
        const desc = row.querySelector('.edit-extra-charge-desc').value.trim();
        const rate = row.querySelector('.edit-extra-charge-rate').value;
        if (desc && rate) {
            extraCharges.push({ description: desc, rate: parseFloat(rate) });
        }
    });
    
    const formData = new FormData();
    formData.append('function_date', document.getElementById('edit_function_date').value);
    formData.append('time_from', document.getElementById('edit_time_from').value);
    formData.append('time_to', document.getElementById('edit_time_to').value);
    formData.append('function_name', document.getElementById('edit_function_name').value);
    formData.append('booked_by', document.getElementById('edit_booked_by').value);
    formData.append('contact_numbers', JSON.stringify(contactNumbers));
    formData.append('address', document.getElementById('edit_address').value);
    formData.append('menu_items', JSON.stringify(menuItems));
    formData.append('no_of_pax', document.getElementById('edit_no_of_pax').value);
    formData.append('rate_per_pax', document.getElementById('edit_rate_per_pax').value);
    formData.append('gst_option', document.querySelector('input[name="edit_gst_option"]:checked').value);
    formData.append('hall_rent', document.getElementById('edit_hall_rent').value || 0);
    formData.append('extra_charges', JSON.stringify(extraCharges));
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
    
    fetch(`/api/functions/{{ function.id }}/update/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            successDiv.textContent = 'Function updated successfully!';
            successDiv.classList.remove('d-none');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            errorDiv.textContent = data.error || 'Failed to update function';
            errorDiv.classList.remove('d-none');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Function';
        }
    })
    .catch(err => {
        console.error(err);
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Function';
    });
});


</script>

{% endblock %}